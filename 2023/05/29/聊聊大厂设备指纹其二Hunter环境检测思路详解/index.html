<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>聊聊大厂设备指纹其二Hunter环境检测思路详解! | 听说你是小兔叽的博客</title><meta name="author" content="听说你是小兔叽"><meta name="copyright" content="听说你是小兔叽"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="前言：昨天发现自己有点发烧，今天测一下果然阳了，大早上起来睡不着 。 请假以后正好闲着没事，完善一下之前文章 https:&#x2F;&#x2F;bbs.kanxue.com&#x2F;thread-273759.htm 。 之前一直想写来着，但是一直没时间 。之前这篇文章介绍了。设备指纹基础对抗思路和原理 。很多都是基础部分 。这一篇将更详细的介绍一些常见的检测思路和方法，还有一些主流对抗手段 。 其中包括很多大厂头疼的一些">
<meta property="og:type" content="article">
<meta property="og:title" content="聊聊大厂设备指纹其二Hunter环境检测思路详解!">
<meta property="og:url" content="http://example.com/2023/05/29/%E8%81%8A%E8%81%8A%E5%A4%A7%E5%8E%82%E8%AE%BE%E5%A4%87%E6%8C%87%E7%BA%B9%E5%85%B6%E4%BA%8CHunter%E7%8E%AF%E5%A2%83%E6%A3%80%E6%B5%8B%E6%80%9D%E8%B7%AF%E8%AF%A6%E8%A7%A3/index.html">
<meta property="og:site_name" content="听说你是小兔叽的博客">
<meta property="og:description" content="前言：昨天发现自己有点发烧，今天测一下果然阳了，大早上起来睡不着 。 请假以后正好闲着没事，完善一下之前文章 https:&#x2F;&#x2F;bbs.kanxue.com&#x2F;thread-273759.htm 。 之前一直想写来着，但是一直没时间 。之前这篇文章介绍了。设备指纹基础对抗思路和原理 。很多都是基础部分 。这一篇将更详细的介绍一些常见的检测思路和方法，还有一些主流对抗手段 。 其中包括很多大厂头疼的一些">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/linear-gradient(20deg,%20#0062be,%20#925696,%20#cc426e,%20#fb0347)">
<meta property="article:published_time" content="2023-05-29T03:57:45.000Z">
<meta property="article:modified_time" content="2023-05-29T04:13:59.464Z">
<meta property="article:author" content="听说你是小兔叽">
<meta property="article:tag" content="转贴">
<meta property="article:tag" content="环境检测">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/linear-gradient(20deg,%20#0062be,%20#925696,%20#cc426e,%20#fb0347)"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://example.com/2023/05/29/%E8%81%8A%E8%81%8A%E5%A4%A7%E5%8E%82%E8%AE%BE%E5%A4%87%E6%8C%87%E7%BA%B9%E5%85%B6%E4%BA%8CHunter%E7%8E%AF%E5%A2%83%E6%A3%80%E6%B5%8B%E6%80%9D%E8%B7%AF%E8%AF%A6%E8%A7%A3/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#1f1f1f","position":"bottom-left"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '聊聊大厂设备指纹其二Hunter环境检测思路详解!',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: false,
  postUpdate: '2023-05-29 12:13:59'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/favicon.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">14</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">22</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="not-top-img" id="page-header"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">听说你是小兔叽的博客</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav></header><main class="layout" id="content-inner"><div id="post"><div id="post-info"><h1 class="post-title">聊聊大厂设备指纹其二Hunter环境检测思路详解!</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-05-29T03:57:45.000Z" title="发表于 2023-05-29 11:57:45">2023-05-29</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-05-29T04:13:59.464Z" title="更新于 2023-05-29 12:13:59">2023-05-29</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="聊聊大厂设备指纹其二Hunter环境检测思路详解!"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span><span class="post-meta-separator">|</span><span class="post-meta-commentcount"><i class="far fa-comments fa-fw post-meta-icon"></i><span class="post-meta-label">评论数:</span><a href="/2023/05/29/%E8%81%8A%E8%81%8A%E5%A4%A7%E5%8E%82%E8%AE%BE%E5%A4%87%E6%8C%87%E7%BA%B9%E5%85%B6%E4%BA%8CHunter%E7%8E%AF%E5%A2%83%E6%A3%80%E6%B5%8B%E6%80%9D%E8%B7%AF%E8%AF%A6%E8%A7%A3/#post-comment"><span class="gitalk-comment-count"><i class="fa-solid fa-spinner fa-spin"></i></span></a></span></div></div></div><article class="post-content" id="article-container"><p>前言：<br>昨天发现自己有点发烧，今天测一下果然阳了，大早上起来睡不着 。</p>
<p>请假以后正好闲着没事，完善一下之前文章 <a target="_blank" rel="noopener" href="https://bbs.kanxue.com/thread-273759.htm">https://bbs.kanxue.com/thread-273759.htm</a> 。</p>
<p>之前一直想写来着，但是一直没时间 。之前这篇文章介绍了。设备指纹基础对抗思路和原理 。很多都是基础部分 。这一篇将更详细的介绍一些常见的检测思路和方法，还有一些主流对抗手段 。</p>
<p>其中包括很多大厂头疼的一些事情，如何手机恢复出厂设置也能保证设备指纹不发生变化，保证稳定性 。这篇文章里面也都会详细介绍 。</p>
<p>如果没看过我之前的这篇文章，所以没看过的同学可以先看看这个文章 。之前有的这篇文章里面就不多二次介绍了 。</p>
<p>还有就是一个设备指纹大厂会使用多种方式去获取，那么我们应该如何进行对抗 ，我也会在文章里面说一下我自己的见解和方案，如何在一个“最佳”点去解决问题 ，当然如果你有更好的方案，也可以私聊我。</p>
<p>设备指纹：<br>Android Id<br>聊到设备指纹最经典的一个字段就是Android id，就我目前所知，他的获取方式不下5种 。分别介绍一下 。</p>
<p>方法1：<br>最基础的Android id获取方式 ，这个不多说，直接Hook就行 。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//原始获取android id</span><br><span class="hljs-type">String</span> <span class="hljs-variable">androidId</span> <span class="hljs-operator">=</span> Settings.Secure.getString(context.getContentResolver(), Settings.Secure.ANDROID_ID);<br>CLog.i(String.format(<span class="hljs-string">&quot;android_id -&gt; 2222 %s&quot;</span>, androidId));<br></code></pre></td></tr></table></figure>
<p>方法2：<br>第一种获取以后，系统会把Android id 保存起来，保存到一个HashMap里面，防止多次IPC初始化 ，所以为了验证第一种方法的准确性，可以二次获取cache ，</p>
<p>和上面的Android id进行对比 。9.0以上需要绕过Android id 的反射限制 。具体获取方法如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//通过反射查询android id cache</span><br><span class="hljs-type">ArrayMap</span> <span class="hljs-variable">mValues</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br><span class="hljs-keyword">try</span> &#123;<br>    <span class="hljs-type">Field</span> <span class="hljs-variable">sNameValueCache</span> <span class="hljs-operator">=</span> Settings.Secure.class.getDeclaredField(<span class="hljs-string">&quot;sNameValueCache&quot;</span>);<br>    sNameValueCache.setAccessible(<span class="hljs-literal">true</span>);<br>    <span class="hljs-type">Object</span> <span class="hljs-variable">sLockSettings</span> <span class="hljs-operator">=</span> sNameValueCache.get(<span class="hljs-literal">null</span>);<br>    <span class="hljs-type">Field</span> <span class="hljs-variable">fieldmValues</span> <span class="hljs-operator">=</span> sLockSettings.getClass().getDeclaredField(<span class="hljs-string">&quot;mValues&quot;</span>);<br>    fieldmValues.setAccessible(<span class="hljs-literal">true</span>);<br>    mValues = (ArrayMap&lt;String,String&gt;) fieldmValues.get(sLockSettings);<br>    <span class="hljs-type">String</span> <span class="hljs-variable">android_id</span> <span class="hljs-operator">=</span> (String)mValues.get(<span class="hljs-string">&quot;android_id&quot;</span>);<br>    CLog.i(String.format(<span class="hljs-string">&quot;android_id -&gt; 3333 %s&quot;</span>, android_id));<br>&#125; <span class="hljs-keyword">catch</span> (Throwable e) &#123;<br>    e.printStackTrace();<br>&#125;<br></code></pre></td></tr></table></figure>
<p>方法3：<br>方法3也是很基础的Api ，主要通过ContentResolver 进行间接获取 。很多大厂也都在使用 。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">try</span> &#123;<br>    <span class="hljs-type">Bundle</span> <span class="hljs-variable">callResult</span> <span class="hljs-operator">=</span> context.getContentResolver().call(<br>            Uri.parse(<span class="hljs-string">&quot;content://settings/secure&quot;</span>), <span class="hljs-string">&quot;GET_secure&quot;</span>, <span class="hljs-string">&quot;android_id&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Bundle</span>()<br>    );<br>    <span class="hljs-type">String</span> <span class="hljs-variable">androidIdValue</span> <span class="hljs-operator">=</span> callResult.getString(<span class="hljs-string">&quot;value&quot;</span>);<br>    CLog.i(String.format(<span class="hljs-string">&quot;android_id -&gt; 1111 %s&quot;</span>, androidIdValue));<br>&#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>    CLog.e(e.toString(), e);<br>&#125;<br></code></pre></td></tr></table></figure>
<p>方法4：<br>通过query命令去查询，获取Android id ，这种方式底层走的也是ContentResolver</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//通过content命令查询android id</span><br><span class="hljs-type">String</span> <span class="hljs-variable">android_id</span> <span class="hljs-operator">=</span> NativeEngine.popen(<br>        <span class="hljs-string">&quot;content query --uri content://settings/secure --where \&quot;name=\\&#x27;android_id\\&#x27;\&quot;&quot;</span>,<br>        <span class="hljs-string">&quot;&quot;</span>);<br>CLog.i(String.format(<span class="hljs-string">&quot;android_id -&gt; 4444 %s&quot;</span>, android_id));<br></code></pre></td></tr></table></figure>
<p>方法5：<br>方法4的代码反射实现，我自己测试在高版本总是有问题 ，不是很稳定 ，所以这里面就不发了 。</p>
<p>硬盘字节总大小：<br>在设备指纹里面，如果想回复出厂设置也能保证原有的设备信息 ，这个字段可以在服务端的相似度算法里面占比很重 ，可以以型号进行分类。，我之前测试过，回复出厂设置指纹也不发生变化的设备指纹核心的设备指纹就几个 。</p>
<p>比如硬盘大小，ipv6 ，还有一个就是MAC地址，这几个设备指纹也是很核心的设备指纹 。首先先介绍硬盘字节大小。 也是三种获取方法，但是方法底层都是一条系统调用。所以如果要进行对抗的话，只需要在SVC层进行处理即可 。获取三种方法如下 ，不建议分别进行处理，可能会导致有地方泄漏，特别是直接开启一条进程通过execve去执行，然后管道传过来，导致很容易Hook不全。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs c++">jclass pJclass = env-&gt;<span class="hljs-built_in">FindClass</span>(<span class="hljs-string">&quot;android/os/StatFs&quot;</span>);<br>jmethodID id = env-&gt;<span class="hljs-built_in">GetMethodID</span>(pJclass, <span class="hljs-string">&quot;&lt;init&gt;&quot;</span>, <span class="hljs-string">&quot;(Ljava/lang/String;)V&quot;</span>);<br>jobject pJobject =<br>        env-&gt;<span class="hljs-built_in">NewObject</span>(pJclass, id, env-&gt;<span class="hljs-built_in">NewStringUTF</span>(<span class="hljs-string">&quot;/storage/emulated/0&quot;</span>));<br> <br>jlong i = env-&gt;<span class="hljs-built_in">CallLongMethod</span>(pJobject, env-&gt;<span class="hljs-built_in">GetMethodID</span>(pJclass, <span class="hljs-string">&quot;getTotalBytes&quot;</span>, <span class="hljs-string">&quot;()J&quot;</span>));<br><span class="hljs-built_in">LOG</span>(ERROR) &lt;&lt; <span class="hljs-string">&quot;Java获取getTotalBytes &quot;</span>&lt;&lt;i;<br> <br> <br> <br><span class="hljs-type">char</span> buffer[<span class="hljs-number">1024</span>];<br>FILE *fp = <span class="hljs-built_in">popen</span>(<span class="hljs-string">&quot;stat -f /storage/emulated/0&quot;</span>, <span class="hljs-string">&quot;r&quot;</span>);<br><span class="hljs-keyword">if</span> (fp != <span class="hljs-literal">nullptr</span>) &#123;<br>    <span class="hljs-keyword">while</span> (<span class="hljs-built_in">fgets</span>(buffer, <span class="hljs-built_in">sizeof</span>(buffer), fp) != <span class="hljs-literal">nullptr</span>) &#123;<br>        <span class="hljs-comment">//LOGI(&quot;ps -ef %s&quot;,buffer)</span><br>        <span class="hljs-built_in">LOG</span>(INFO) &lt;&lt; <span class="hljs-string">&quot;stat -f /storage/emulated/0&quot;</span> &lt;&lt; buffer;<br>    &#125;<br>    <span class="hljs-built_in">pclose</span>(fp);<br>&#125;<br> <br> <br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">statfs64</span> buf=&#123;&#125;;<br><span class="hljs-keyword">if</span> (<span class="hljs-built_in">statfs64</span>(<span class="hljs-string">&quot;/storage/emulated/0&quot;</span>, &amp;buf) == <span class="hljs-number">-1</span>) &#123;<br>    <span class="hljs-built_in">LOG</span>(ERROR) &lt;&lt; <span class="hljs-string">&quot;statfs64系统信息失败&quot;</span>;<br>    <span class="hljs-keyword">return</span>;<br>&#125;<br><span class="hljs-built_in">LOG</span>(INFO) &lt;&lt; <span class="hljs-string">&quot;f_type (文件系统类型): &quot;</span> &lt;&lt; buf.f_type;<br><span class="hljs-built_in">LOG</span>(INFO) &lt;&lt; <span class="hljs-string">&quot;f_bsize (块大小): &quot;</span> &lt;&lt; buf.f_bsize;<br><span class="hljs-built_in">LOG</span>(INFO) &lt;&lt; <span class="hljs-string">&quot;f_blocks (总数据块): &quot;</span> &lt;&lt; buf.f_blocks;<br><span class="hljs-built_in">LOG</span>(INFO) &lt;&lt; <span class="hljs-string">&quot;f_bfree (空闲块): &quot;</span> &lt;&lt; buf.f_bfree;<br><span class="hljs-built_in">LOG</span>(INFO) &lt;&lt; <span class="hljs-string">&quot;f_bavail (非特权用户可用的空闲块): &quot;</span> &lt;&lt; buf.f_bavail;<br><span class="hljs-built_in">LOG</span>(INFO) &lt;&lt; <span class="hljs-string">&quot;f_files (总文件节点数): &quot;</span> &lt;&lt; buf.f_files;<br><span class="hljs-built_in">LOG</span>(INFO) &lt;&lt; <span class="hljs-string">&quot;f_ffree (空闲文件节点数): &quot;</span> &lt;&lt; buf.f_ffree;<br><span class="hljs-built_in">LOG</span>(INFO) &lt;&lt; <span class="hljs-string">&quot;f_fsid (文件系统 ID): &quot;</span> &lt;&lt; buf.f_fsid.__val[<span class="hljs-number">0</span>] &lt;&lt; <span class="hljs-string">&quot;, &quot;</span> &lt;&lt; buf.f_fsid.__val[<span class="hljs-number">1</span>];<br><span class="hljs-built_in">LOG</span>(INFO) &lt;&lt; <span class="hljs-string">&quot;f_namelen (最大文件名长度): &quot;</span> &lt;&lt; buf.f_namelen;<br><br></code></pre></td></tr></table></figure>
<p>我之前也是参考的平头哥，Hook的Java方法，但是发现Native层并不能全量拦截 。后来弃用 。平头哥方法代码如下：</p>
<figure class="highlight java"><figcaption><span>Xposed</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">relocateRomMemInfo</span><span class="hljs-params">(VirtualBaseInfo virtualBaseInfo)</span> &#123;<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">androidSystemOsClassName</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;android.system.Os&quot;</span>;<br>    Class&lt;?&gt; androidSystemOsClass =<br>            RposedHelpers.findClassIfExists(androidSystemOsClassName, ClassLoader.getSystemClassLoader());<br>    <span class="hljs-keyword">if</span> (androidSystemOsClass == <span class="hljs-literal">null</span>) &#123;<br>        CLog.e(<span class="hljs-string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; vfs android.system.Os not found&quot;</span>);<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br>    RposedHelpers.findAndHookMethod(androidSystemOsClass, <span class="hljs-string">&quot;statvfs&quot;</span>, String.class, <span class="hljs-keyword">new</span> <span class="hljs-title class_">RC_MethodHook</span>() &#123;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">afterHookedMethod</span><span class="hljs-params">(MethodHookParam param)</span> <span class="hljs-keyword">throws</span> Throwable &#123;<br>            <span class="hljs-keyword">if</span>(param.getResult() == <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-keyword">return</span>;<br>            &#125;<br>            <span class="hljs-type">StructStatVfs</span> <span class="hljs-variable">structStatVfs</span> <span class="hljs-operator">=</span> (StructStatVfs) param.getResult();<br>            <span class="hljs-keyword">if</span> (structStatVfs.f_blocks == <span class="hljs-number">0</span>) &#123;<br>                <span class="hljs-keyword">return</span>;<br>            &#125;<br>            <span class="hljs-keyword">if</span>(param.args[<span class="hljs-number">0</span>] <span class="hljs-keyword">instanceof</span> String) &#123;<br>                <span class="hljs-type">long</span> <span class="hljs-variable">mockRomOut</span> <span class="hljs-operator">=</span> getMockRomOut(structStatVfs.f_blocks, virtualBaseInfo, structStatVfs.f_blocks);<br>                CLog.i(TAG, <span class="hljs-string">&quot;vfs statvfs path:&quot;</span> + param.args[<span class="hljs-number">0</span>] + <span class="hljs-string">&quot; f_blocks:&quot;</span> + structStatVfs.f_blocks + <span class="hljs-string">&quot; mock value:&quot;</span> + mockRomOut);<br>                RposedHelpers.setObjectField(<br>                        structStatVfs,<br>                        <span class="hljs-string">&quot;f_blocks&quot;</span>,<br>                        mockRomOut<br>                );<br>            &#125;<br>        &#125;<br>    &#125;);<br>&#125;<br></code></pre></td></tr></table></figure>
<p>上面这种方式只适合Java获取，具体三种获取方法可以看下面 。</p>
<p>这三种方法底层走的都是statfs64 或者statfs函数，对抗的话也很简单，直接在statfs64 或者statfs 的after里面对参数2进行替换和复写即可 。</p>
<p>对抗如下，具体如何拦截svc代码可以参考proot ,可以参考我之前写的文章 <a target="_blank" rel="noopener" href="https://bbs.kanxue.com/thread-273160.htm">https://bbs.kanxue.com/thread-273160.htm</a></p>
<p>这种方法的好处就是不管如何开进程，都可以在底层统一处理 。</p>
<figure class="highlight c"><figcaption><span>++</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs c">        <span class="hljs-comment">//int statfs(const char *path, struct statfs *buf);</span><br>        <span class="hljs-comment">//int statfs64(const char *path, struct statfs64 *buf);</span><br>        <span class="hljs-keyword">case</span> SC_statfs:<br>        <span class="hljs-keyword">case</span> SC_statfs64: &#123;<br>            <span class="hljs-keyword">if</span> (isMockFingerptint()) &#123;<br>                <span class="hljs-keyword">if</span> ((<span class="hljs-type">int</span>) syscall_result &lt; <span class="hljs-number">0</span>) &#123;<br>                    <span class="hljs-keyword">break</span>;<br>                &#125;<br><span class="hljs-comment">//              f_type：文件系统类型。</span><br><span class="hljs-comment">//              f_bsize：文件系统块的大小。</span><br><span class="hljs-comment">//              f_blocks：文件系统中的总块数。</span><br><span class="hljs-comment">//              f_bfree：文件系统中的可用块数。</span><br><span class="hljs-comment">//              f_bavail：非超级用户可获取的块数。</span><br><span class="hljs-comment">//              f_files：文件系统中的总文件节点数。</span><br><span class="hljs-comment">//              f_ffree：文件系统中的可用文件节点数。</span><br><span class="hljs-comment">//              f_fsid：文件系统标识。</span><br><span class="hljs-comment">//              f_namelen：文件名的最大长度。</span><br>                <span class="hljs-type">char</span> pathBuff[PATH_MAX];<br>                <span class="hljs-type">word_t</span> pPath = peek_reg(tracee, ORIGINAL, SYSARG_1);<br>                <span class="hljs-type">int</span> ret = read_string(tracee, pathBuff, pPath, PATH_MAX);<br>                <span class="hljs-keyword">if</span>(ret &lt; <span class="hljs-number">0</span>)&#123;<br>                    <span class="hljs-keyword">break</span>;<br>                &#125;<br>                <span class="hljs-keyword">if</span>(get_sysnum(tracee, ORIGINAL) == SC_statfs64)&#123;<br>                    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">statfs64</span> <span class="hljs-title">fs</span> =</span> &#123;&#125;;<br>                    <span class="hljs-type">word_t</span> arg2 = peek_reg(tracee, ORIGINAL, SYSARG_2);<br>                    read_data(tracee,&amp;fs,arg2,<span class="hljs-keyword">sizeof</span> (<span class="hljs-keyword">struct</span> statfs64));<br>                    NativeFingerHandler::StatfsHandler64(pathBuff,&amp;fs);<br>                    write_data(tracee,arg2,&amp;fs,<span class="hljs-keyword">sizeof</span> (<span class="hljs-keyword">struct</span> statfs64));<br>                &#125; <span class="hljs-keyword">else</span>&#123;<br>                    <span class="hljs-keyword">struct</span> statfs fs = &#123;&#125;;<br>                    <span class="hljs-type">word_t</span> arg2 = peek_reg(tracee, ORIGINAL, SYSARG_2);<br>                    read_data(tracee,&amp;fs,arg2,<span class="hljs-keyword">sizeof</span> (<span class="hljs-keyword">struct</span> statfs));<br>                    NativeFingerHandler::StatfsHandler32(pathBuff,&amp;fs);<br>                    write_data(tracee,arg2,&amp;fs,<span class="hljs-keyword">sizeof</span> (<span class="hljs-keyword">struct</span> statfs));<br>                &#125;<br>            &#125;<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br></code></pre></td></tr></table></figure>
<p>Mac地址：<br>这个没啥好说的，基础字段，Java层获取，netlink获取，命令行获取 。读文件获取，四种获取方法，和上面类似 ，直接在svc的 recvmsg ，recv，recvfrom的after进行数据包替换即可。netlink获取mac方法可以参考我之前的代码 。</p>
<p><a target="_blank" rel="noopener" href="https://bbs.kanxue.com/thread-271698.htm">https://bbs.kanxue.com/thread-271698.htm</a></p>
<p>如果判断是netlink的消息，并且是获取网卡类型直接对里面的数据包解析和替换即可 。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">case</span> SC_recvmsg: &#123;<br>    <span class="hljs-comment">//LOGI(&quot;start handle SC_recvmsg systexit after&quot;)</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">isMockFingerptint</span>()) &#123;<br>        NetlinkMacHandler::<span class="hljs-built_in">netlinkHandler_recmsg</span>(tracee);<br>    &#125;<br>    <span class="hljs-keyword">break</span>;<br>&#125;<br><span class="hljs-keyword">case</span> SC_recv:<br><span class="hljs-keyword">case</span> SC_recvfrom: &#123;<br>    <span class="hljs-comment">//LOGE(&quot;start handle SC_recvfrom systexit after&quot;)</span><br>    <span class="hljs-comment">//recv底层走的recvfrom,所以不需要处理recvfrom</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">isMockFingerptint</span>()) &#123;<br>        NetlinkMacHandler::<span class="hljs-built_in">netlinkHandler_recv</span>(tracee);<br>    &#125;<br>    <span class="hljs-keyword">break</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>在读文件获取这块因为网卡信息已经在内存里面 ，所以直接IO重定向过去即可 。</p>
<p>常用的获取网卡信息的文件 ，以wlan0为例子 ,场景的获取目录如下：可以cat获取，也可以直接读文件 。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">/sys/class/net/wlan0/address<br>/sys/devices/virtual/net/wlan0/address<br>...<br></code></pre></td></tr></table></figure>
<p>附近网卡信息：<br>这个字段主要是监控群控的一些信息的，主要作用是获取当前wifi 附近的人MAC信息的 。</p>
<p>比如大厂一般检测群控的手段就是获取附近的网卡，如果有聚集性就可以认为是群控 。获取的方式也也跟上面一样 。五种获取方法 。</p>
<p>获取方法底层也是和MAC获取方法一样 ，底层都是netlink，比如可以直接执行 popen获取 ，</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">popen(&quot;ip neigh show&quot;, &quot;r&quot;);<br></code></pre></td></tr></table></figure>
<p>也可以直接直接读文件 ，路径如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">/proc/net/arp<br></code></pre></td></tr></table></figure>
<p>还可以直接netlink获取 ，在收到消息以后判断消息类型是 hdr-&gt;nlmsg_type &#x3D;&#x3D; RTM_NEWNEIGH 直接进行替换即可 。</p>
<p>直接在recv收到消息以后对数据里面的buff进行替换即可 。主要核心代码如下 。包括上面的mac地址替换 。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-type">static</span> <span class="hljs-type">void</span> _getifaddrs_callback(<span class="hljs-type">void</span> *context, nlmsghdr *hdr) &#123;<br>    <span class="hljs-keyword">auto</span> **out = <span class="hljs-built_in">reinterpret_cast</span>&lt;ifaddrs **&gt;(context);<br> <br>    <span class="hljs-comment">//首先先判断消息类型是不是RTM_NEWLINK类型</span><br>    <span class="hljs-keyword">if</span> (hdr-&gt;nlmsg_type == RTM_NEWLINK) &#123;<br>        <span class="hljs-keyword">auto</span> *ifi = <span class="hljs-built_in">reinterpret_cast</span>&lt;ifinfomsg *&gt;(<span class="hljs-built_in">NLMSG_DATA</span>(hdr));<br> <br>        <span class="hljs-function">ifaddrs_storage <span class="hljs-title">new_addr</span><span class="hljs-params">(out)</span></span>;<br>        new_addr.interface_index = ifi-&gt;ifi_index;<br>        new_addr.ifa.ifa_flags = ifi-&gt;ifi_flags;<br> <br>        <span class="hljs-comment">// Get the interface name</span><br>        <span class="hljs-type">char</span> ifname[IFNAMSIZ];<br>        if_indextoname(ifi-&gt;ifi_index, ifname);<br> <br>        <span class="hljs-comment">// Go through the various bits of information and find the name.</span><br>        rtattr *rta = <span class="hljs-built_in">IFLA_RTA</span>(ifi);<br>        <span class="hljs-comment">//获取这个消息的长度</span><br>        <span class="hljs-type">size_t</span> rta_len = <span class="hljs-built_in">IFLA_PAYLOAD</span>(hdr);<br>        <span class="hljs-comment">//这块是判断这个消息是否是合格的消息</span><br>        <span class="hljs-keyword">while</span> (<span class="hljs-built_in">RTA_OK</span>(rta, rta_len)) &#123;<br>            <span class="hljs-keyword">if</span> (rta-&gt;rta_type == IFLA_ADDRESS)&#123;<br>                <span class="hljs-keyword">if</span> (<span class="hljs-built_in">RTA_PAYLOAD</span>(rta) &lt; <span class="hljs-built_in">sizeof</span>(new_addr.addr)) &#123;<br>                    <span class="hljs-type">void</span> *data = <span class="hljs-built_in">RTA_DATA</span>(rta);<br>                    <span class="hljs-comment">//修改mac地址</span><br>                    <span class="hljs-built_in">setMacInData</span>(data, ifname, ZHENXI_RUNTIME_NETLINK_MAC, <span class="hljs-literal">false</span>);<br>                    new_addr.<span class="hljs-built_in">SetAddress</span>(AF_PACKET, data, <span class="hljs-built_in">RTA_PAYLOAD</span>(rta));<br>                    new_addr.<span class="hljs-built_in">SetPacketAttributes</span>(ifi-&gt;ifi_index, ifi-&gt;ifi_type,<br>                                                 <span class="hljs-built_in">RTA_PAYLOAD</span>(rta));<br>                &#125;<br>            &#125;<br>            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (rta-&gt;rta_type == IFLA_BROADCAST) &#123;<br>                <span class="hljs-keyword">if</span> (<span class="hljs-built_in">RTA_PAYLOAD</span>(rta) &lt; <span class="hljs-built_in">sizeof</span>(new_addr.ifa_ifu)) &#123;<br>                    <span class="hljs-type">void</span> *data = <span class="hljs-built_in">RTA_DATA</span>(rta);<br>                    <span class="hljs-type">size_t</span> byteCount = <span class="hljs-built_in">RTA_PAYLOAD</span>(rta);<br>                    new_addr.<span class="hljs-built_in">SetBroadcastAddress</span>(AF_PACKET, data, byteCount);<br>                    new_addr.<span class="hljs-built_in">SetPacketAttributes</span>(ifi-&gt;ifi_index, ifi-&gt;ifi_type,<br>                                                 <span class="hljs-built_in">RTA_PAYLOAD</span>(rta));<br>                &#125;<br>            &#125;<br>            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (rta-&gt;rta_type == IFLA_IFNAME) &#123;<br>                <span class="hljs-keyword">if</span> (<span class="hljs-built_in">RTA_PAYLOAD</span>(rta) &lt; <span class="hljs-built_in">sizeof</span>(new_addr.name)) &#123;<br>                    <span class="hljs-built_in">memcpy</span>(new_addr.name, <span class="hljs-built_in">RTA_DATA</span>(rta), <span class="hljs-built_in">RTA_PAYLOAD</span>(rta));<br>                    new_addr.ifa.ifa_name = new_addr.name;<br>                &#125;<br>            &#125;<br>            rta = <span class="hljs-built_in">RTA_NEXT</span>(rta, rta_len);<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (hdr-&gt;nlmsg_type == RTM_NEWADDR) &#123;<br>        <span class="hljs-comment">//这个类型在获取网卡的时候未发现调用</span><br>        <span class="hljs-keyword">auto</span> *msg = <span class="hljs-built_in">reinterpret_cast</span>&lt;ifaddrmsg *&gt;(<span class="hljs-built_in">NLMSG_DATA</span>(hdr));<br> <br> <br>        <span class="hljs-comment">// We should already know about this from an RTM_NEWLINK message.</span><br>        <span class="hljs-type">const</span> <span class="hljs-keyword">auto</span> *addr = <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">const</span> ifaddrs_storage *&gt;(*out);<br> <br>        <span class="hljs-keyword">while</span> (addr != <span class="hljs-literal">nullptr</span> &amp;&amp; addr-&gt;interface_index != <span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-type">int</span>&gt;(msg-&gt;ifa_index)) &#123;<br>            <span class="hljs-comment">//LOGE(&quot;Current interface index: %d&quot;, addr-&gt;interface_index); // 添加当前接口索引日志</span><br>            addr = <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">const</span> ifaddrs_storage *&gt;(addr-&gt;ifa.ifa_next);<br>        &#125;<br>        <span class="hljs-comment">// If this is an unknown interface,</span><br>        <span class="hljs-comment">// ignore whatever we&#x27;re being told about it.</span><br>        <span class="hljs-keyword">if</span> (addr == <span class="hljs-literal">nullptr</span>) &#123;<br>            <span class="hljs-comment">//LOGE (&quot;_getifaddrs_callback RTM_NEWADDR return&quot;)</span><br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        <span class="hljs-function">ifaddrs_storage <span class="hljs-title">new_addr</span><span class="hljs-params">(out)</span></span>;<br>        <span class="hljs-built_in">strcpy</span>(new_addr.name, addr-&gt;name);<br>        new_addr.ifa.ifa_name = new_addr.name;<br>        new_addr.ifa.ifa_flags = addr-&gt;ifa.ifa_flags;<br>        new_addr.interface_index = addr-&gt;interface_index;<br>        <span class="hljs-comment">// Go through the various bits of information and find the address</span><br>        <span class="hljs-comment">// and any broadcast/destination address.</span><br>        rtattr *rta = <span class="hljs-built_in">IFA_RTA</span>(msg);<br>        <span class="hljs-type">size_t</span> rta_len = <span class="hljs-built_in">IFA_PAYLOAD</span>(hdr);<br>        <span class="hljs-keyword">while</span> (<span class="hljs-built_in">RTA_OK</span>(rta, rta_len)) &#123;<br>            <span class="hljs-built_in">LOGE</span>(<span class="hljs-string">&quot;RTA type: %d&quot;</span>, rta-&gt;rta_type);<br>            <span class="hljs-keyword">if</span> (rta-&gt;rta_type == IFA_ADDRESS) &#123;<br>                <span class="hljs-comment">//LOGE (&quot;_getifaddrs_callback RTM_NEWADDR IFA_ADDRESS %d &quot;,msg-&gt;ifa_family)</span><br>                <span class="hljs-keyword">if</span> (msg-&gt;ifa_family == AF_INET || msg-&gt;ifa_family == AF_INET6) &#123;<br>                    <span class="hljs-type">void</span> *data = <span class="hljs-built_in">RTA_DATA</span>(rta);<br>                    <span class="hljs-comment">// 确保 RTA_DATA(rta) 的大小是正确的</span><br>                    <span class="hljs-keyword">if</span> (msg-&gt;ifa_family == AF_INET6 &amp;&amp; <span class="hljs-built_in">RTA_PAYLOAD</span>(rta) &lt; <span class="hljs-built_in">sizeof</span>(<span class="hljs-keyword">struct</span> in6_addr)) &#123;<br>                        <span class="hljs-built_in">LOGE</span>(<span class="hljs-string">&quot;RTA_PAYLOAD size is less than sizeof(struct in6_addr)&quot;</span>);<br>                        <span class="hljs-keyword">return</span>;<br>                    &#125;<br>                    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">in6_addr</span> addr_v6_address&#123;&#125;;<br>                    <span class="hljs-built_in">memcpy</span>(&amp;addr_v6_address, <span class="hljs-built_in">RTA_DATA</span>(rta), <span class="hljs-built_in">sizeof</span>(<span class="hljs-keyword">struct</span> in6_addr));<br>                    <span class="hljs-type">char</span> str[INET6_ADDRSTRLEN];<br>                    <span class="hljs-built_in">inet_ntop</span>(AF_INET6, &amp;addr_v6_address, str, <span class="hljs-built_in">sizeof</span>(str));<br>                    <span class="hljs-built_in">LOGE</span>(<span class="hljs-string">&quot;RTM_NEWADDR&amp;IFA_ADDRESS&amp;AF_INET6 111 %s&quot;</span>, str)<br> <br>                    <span class="hljs-type">size_t</span> byteCount = <span class="hljs-built_in">RTA_PAYLOAD</span>(rta);<br>                    <span class="hljs-built_in">LOGE</span> (<span class="hljs-string">&quot;RTM_NEWADDR&amp;IFA_ADDRESS %zu  %s &quot;</span>,<br>                          byteCount, <span class="hljs-built_in">getpData</span>(data, byteCount).<span class="hljs-built_in">c_str</span>())<br>                    new_addr.<span class="hljs-built_in">SetAddress</span>(msg-&gt;ifa_family, data, byteCount);<br>                    new_addr.<span class="hljs-built_in">SetNetmask</span>(msg-&gt;ifa_family, msg-&gt;ifa_prefixlen);<br>                &#125;<br>            &#125;<br>            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (rta-&gt;rta_type == IFA_BROADCAST) &#123;<br>                <span class="hljs-keyword">if</span> (msg-&gt;ifa_family == AF_INET||msg-&gt;ifa_family == AF_INET6) &#123;<br>                    <span class="hljs-type">void</span> *data = <span class="hljs-built_in">RTA_DATA</span>(rta);<br>                    <span class="hljs-type">size_t</span> byteCount = <span class="hljs-built_in">RTA_PAYLOAD</span>(rta);<br>                    <span class="hljs-built_in">LOGE</span> (<span class="hljs-string">&quot;RTM_NEWADDR&amp;IFA_BROADCAST %zu  %s &quot;</span>,<br>                          byteCount, <span class="hljs-built_in">getpData</span>(data, byteCount).<span class="hljs-built_in">c_str</span>())<br>                    new_addr.<span class="hljs-built_in">SetBroadcastAddress</span>(msg-&gt;ifa_family, data,<br>                                                 byteCount);<br>                &#125;<br>            &#125;<br>            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (rta-&gt;rta_type == IFA_LOCAL) &#123;<br>                <span class="hljs-comment">//LOGE (&quot;_getifaddrs_callback RTM_NEWADDR IFA_LOCAL %d &quot;,msg-&gt;ifa_family)</span><br>                <span class="hljs-keyword">if</span> (msg-&gt;ifa_family == AF_INET || msg-&gt;ifa_family == AF_INET6) &#123;<br>                    <span class="hljs-type">void</span> *data = <span class="hljs-built_in">RTA_DATA</span>(rta);<br>                    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">in6_addr</span> addr_v6_local&#123;&#125;;<br>                    <span class="hljs-built_in">memcpy</span>(&amp;addr_v6_local, <span class="hljs-built_in">RTA_DATA</span>(rta), <span class="hljs-built_in">sizeof</span>(<span class="hljs-keyword">struct</span> in6_addr));<br>                    <span class="hljs-type">char</span> str[INET6_ADDRSTRLEN];<br>                    <span class="hljs-built_in">inet_ntop</span>(AF_INET6, &amp;addr_v6_local, str, <span class="hljs-built_in">sizeof</span>(str));<br>                    <span class="hljs-built_in">LOGE</span>(<span class="hljs-string">&quot;RTM_NEWADDR&amp;IFA_ADDRESS&amp;AF_INET6 222 %s&quot;</span>, str)<br> <br>                    <span class="hljs-type">size_t</span> byteCount = <span class="hljs-built_in">RTA_PAYLOAD</span>(rta);<br>                    <span class="hljs-built_in">LOGE</span> (<span class="hljs-string">&quot;RTM_NEWADDR&amp;IFA_LOCAL %zu  %s &quot;</span>,<br>                          byteCount, <span class="hljs-built_in">getpData</span>(data, byteCount).<span class="hljs-built_in">c_str</span>())<br>                    new_addr.<span class="hljs-built_in">SetLocalAddress</span>(msg-&gt;ifa_family, data, byteCount);<br>                &#125;<br>            &#125;<br>            rta = <span class="hljs-built_in">RTA_NEXT</span>(rta, rta_len);<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (hdr-&gt;nlmsg_type == RTM_NEWNEIGH) &#123;<br>        <span class="hljs-comment">// RTM_NEWNEIGH 类型消息为网上邻居(arp表)，需要进行随机化</span><br>        <span class="hljs-keyword">auto</span> *ifinfo = <span class="hljs-built_in">reinterpret_cast</span>&lt;ndmsg *&gt;(<span class="hljs-built_in">NLMSG_DATA</span>(hdr));<br>        rtattr *rta = <span class="hljs-built_in">NDA_RTA</span>(ifinfo);<br>        <span class="hljs-type">size_t</span> rta_len = <span class="hljs-built_in">NDA_PAYLOAD</span>(hdr);<br> <br>        <span class="hljs-type">int</span> if_index = ifinfo-&gt;ndm_ifindex;<br>        <span class="hljs-type">char</span> if_name[IFNAMSIZ];<br>        if_indextoname(if_index, if_name);<br>        <span class="hljs-comment">//遍历具体的消息类型</span><br>        <span class="hljs-keyword">while</span> (<span class="hljs-built_in">RTA_OK</span>(rta, rta_len)) &#123;<br>            <span class="hljs-comment">//a neighbor cache n/w layer destination address</span><br>            <span class="hljs-comment">//邻居缓存nw层目标地址,ip地址区分32和64</span><br>            <span class="hljs-comment">//ip地址,ip可以是v4也可以是v6</span><br>            <span class="hljs-keyword">if</span> (rta-&gt;rta_type == NDA_DST) &#123;<br>                <span class="hljs-keyword">if</span> (ifinfo-&gt;ndm_family == AF_INET) &#123;<br>                    <span class="hljs-comment">//32</span><br>                    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">in_addr</span> addr&#123;&#125;;<br>                    <span class="hljs-built_in">memcpy</span>(&amp;addr, <span class="hljs-built_in">RTA_DATA</span>(rta), <span class="hljs-built_in">sizeof</span>(<span class="hljs-keyword">struct</span> in_addr));<br>                    <span class="hljs-type">char</span> *ntoa = <span class="hljs-built_in">inet_ntoa</span>(addr);<br>                    <span class="hljs-comment">//LOGE(&quot;NDA_DST&amp;AF_INET   %s&quot;, inet_ntoa(addr))</span><br>                &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (ifinfo-&gt;ndm_family == AF_INET6) &#123;<br>                    <span class="hljs-comment">//64</span><br>                    <span class="hljs-keyword">struct</span> in6_addr addr&#123;&#125;;<br>                    <span class="hljs-built_in">memcpy</span>(&amp;addr, <span class="hljs-built_in">RTA_DATA</span>(rta), <span class="hljs-built_in">sizeof</span>(<span class="hljs-keyword">struct</span> in6_addr));<br>                    <span class="hljs-type">char</span> str[INET6_ADDRSTRLEN];<br>                    <span class="hljs-built_in">inet_ntop</span>(AF_INET6, &amp;addr, str, <span class="hljs-built_in">sizeof</span>(str));<br>                    <span class="hljs-comment">//LOGE(&quot;NDA_DST&amp;AF_INET6  %s&quot;, str);</span><br>                &#125;<br>            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (rta-&gt;rta_type == NDA_LLADDR) &#123;<br>                <span class="hljs-comment">//网卡地址</span><br>                <span class="hljs-keyword">auto</span> *data = <span class="hljs-built_in">RTA_DATA</span>(rta);<br>                <span class="hljs-built_in">setMacInData</span>(data, if_name, ZHENXI_RUNTIME_NETLINK_NEIGH, <span class="hljs-literal">true</span>);<br>            &#125;<br>            rta = <span class="hljs-built_in">RTA_NEXT</span>(rta, rta_len);<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (hdr-&gt;nlmsg_type == RTM_GETADDR) &#123;<br>        <span class="hljs-comment">//LOGE(&quot;RTM_GETADDR &quot;)</span><br>        <span class="hljs-keyword">auto</span> *ifa = <span class="hljs-built_in">reinterpret_cast</span>&lt;ifaddrmsg *&gt;(<span class="hljs-built_in">NLMSG_DATA</span>(hdr));<br> <br>        <span class="hljs-comment">// Get the interface name</span><br>        <span class="hljs-type">char</span> ifname[IFNAMSIZ];<br>        if_indextoname(ifa-&gt;ifa_index, ifname);<br> <br>        <span class="hljs-comment">// Process the attributes</span><br>        rtattr *rta = <span class="hljs-built_in">IFA_RTA</span>(ifa);<br>        <span class="hljs-type">size_t</span> rta_len = <span class="hljs-built_in">IFA_PAYLOAD</span>(hdr);<br>        <span class="hljs-keyword">while</span> (<span class="hljs-built_in">RTA_OK</span>(rta, rta_len)) &#123;<br>            <span class="hljs-keyword">if</span> (rta-&gt;rta_type == IFA_ADDRESS) &#123;<br>                <span class="hljs-keyword">if</span> (ifa-&gt;ifa_family == AF_INET6) &#123;<br>                    <span class="hljs-comment">// Ensure RTA_DATA(rta) size is correct</span><br>                    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">RTA_PAYLOAD</span>(rta) &lt; <span class="hljs-built_in">sizeof</span>(<span class="hljs-keyword">struct</span> in6_addr)) &#123;<br>                        <span class="hljs-built_in">LOGE</span>(<span class="hljs-string">&quot;RTM_GETADDR RTA_PAYLOAD size is less than sizeof(struct in6_addr)&quot;</span>);<br>                        <span class="hljs-keyword">return</span>;<br>                    &#125;<br>                    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">in6_addr</span> addr_v6_address&#123;&#125;;<br>                    <span class="hljs-built_in">memcpy</span>(&amp;addr_v6_address, <span class="hljs-built_in">RTA_DATA</span>(rta), <span class="hljs-built_in">sizeof</span>(<span class="hljs-keyword">struct</span> in6_addr));<br>                    <span class="hljs-type">char</span> str[INET6_ADDRSTRLEN];<br>                    <span class="hljs-built_in">inet_ntop</span>(AF_INET6, &amp;addr_v6_address, str, <span class="hljs-built_in">sizeof</span>(str));<br>                    <span class="hljs-built_in">LOGE</span>(<span class="hljs-string">&quot;RTM_GETADDR RTM_GETADDR&amp;IFA_ADDRESS&amp;AF_INET6 %s&quot;</span>, str);<br>                &#125;<br>            &#125;<br>            rta = <span class="hljs-built_in">RTA_NEXT</span>(rta, rta_len);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>IPV6：<br>设个设备指纹也是很核心的设备指纹 ，这个玩意底层获取也是netlink，但是netlink获取，但是这块处理很不好处理 ，我暂时也没进行处理 。</p>
<p>常用的获取方式比如，Java获取 ，命令获取。如果需要进行替换的话 ，只需要处理命令行和Java的Hook即可 。</p>
<p>命令行可以在对方执行命令之前，将命令换成cat命令，去cat自己提前Mock好的文件，效果是一样的 。</p>
<p>当然，还有另一种思路，其实这个字段可以服务端获取，客户端二次上报，进行匹配 。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">try &#123;<br>    NetworkInterface networkInterface;<br>    InetAddress inetAddress;<br>    for (Enumeration&lt;NetworkInterface&gt; en = NetworkInterface.getNetworkInterfaces(); en.hasMoreElements(); ) &#123;<br>        networkInterface = en.nextElement();<br>        for (Enumeration&lt;InetAddress&gt; enumIpAddr = networkInterface.getInetAddresses(); enumIpAddr.hasMoreElements(); ) &#123;<br>            inetAddress = enumIpAddr.nextElement();<br>            if (inetAddress instanceof Inet6Address) &#123;<br>                CLog.e(&quot;Java 获取 ipv6 &quot; + inetAddress.getHostAddress());<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125; catch (Throwable ex) &#123;<br>    CLog.e(&quot;printf ipv6 info error &quot; + ex);<br>&#125;<br></code></pre></td></tr></table></figure>
<p>命令行获取如下，ip命令获取如下 。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">ip -6 addr show<br></code></pre></td></tr></table></figure>
<p>打印的内容如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 state UNKNOWN qlen 1000<br>    inet6 ::1/128 scope host<br>       valid_lft forever preferred_lft forever<br>3: dummy0: &lt;BROADCAST,NOARP,UP,LOWER_UP&gt; mtu 1500 state UNKNOWN qlen 1000<br>    inet6 fe80::b86c:79ff:fe96:4945/64 scope link<br>       valid_lft forever preferred_lft forever<br>10: rmnet_data0@rmnet_ipa0: &lt;UP,LOWER_UP&gt; mtu 1500 state UNKNOWN qlen 1000<br>    inet6 fe80::2ad1:b5a0:792b:9ec4/64 scope link<br>       valid_lft forever preferred_lft forever<br>30: wlan0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 state UP qlen 3000<br>    inet6 fe80::8670:a04c:b8cf:467c/64 scope link stable-privacy<br>       valid_lft forever preferred_lft forever<br></code></pre></td></tr></table></figure>
<p>系统内核信息：<br>这玩意底层走的都是uname函数 ，直接对uname系统调用处理即可 。获取方法比如,也可以直接svc调用uname函数 ，也可以直接根据命令行 ，</p>
<p>修改的话也很简单，直接在uname的after里面直接对数据进行替换即可 。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">uname -a<br></code></pre></td></tr></table></figure>
<p>包名随机路径：<br>这个是一个非常非常核心的字段，就是&#x2F;data&#x2F;app&#x2F;随机Base64路径&#x2F;base.apk</p>
<p>这个随机路径就是设备指纹，比如一些大厂会玩，读取你微信的随机路径，获取微信的包信息，然后获取里面的随机路径</p>
<p>比如微信，快手，京东，淘宝这种随机路径 ，作为核心的唯一设备指纹，只要你不卸载微信，或者其他大厂apk ，你得设备指纹永远不发生变化，无论你如何修改他自己Apk里面的信息，跟他都不产生任何影响 。</p>
<p>系统账号：<br>一般尝试比如小米之类的，登入了指定账号，可以得到一个账号的id信息 ，这个也需要处理一下 。最好的办法是不登入账号 。</p>
<p>环境检测：<br>检测环境大多数围绕Hunter的源码检测思路去复现 ，很多都是Hunter的源码 ，很多也都是行业内没有公开的一些检测思路 ，现在市面上检测已经很多没更新了 ，加速行业内卷，我辈刻不容缓 。 ：）</p>
<p>Apk签名:<br>提到环境检测不得不说的就是Apk重打包检测 ，现在检测方法千奇百怪，我这边也是一一罗列一下，把一些可能存在的风险点，检测和绕过的原理详细叙述一下 。当然如果你有更好的思路也可以在文章下面留言。</p>
<p>想要绕过签名检测最好的办法或者说成本最低有效的办法就是修改完毕以后不签名配合核心破解直接安装。</p>
<p>核心破解是lsp的模块，lsp商店直接下载，Hook apk的系统签名解析方法，直接绕过签名检测流程 ，已实现不签名直接安装 。</p>
<p>首先先说一下大厂或者一些企业壳的检测点，Java层基础的获取签名的方法这块就不一一叙述了 。</p>
<p>Native层获取签名方法：<br>检测：<br>这块以Hunter 源码开始介绍 。</p>
<p>核心就三部分 。</p>
<p>svc openat读apk，去解析签名 。<br>检测打开的fd，对fd的路径进行反查，这块有个细节 buff[len] &#x3D; ‘\0’; 就是加这个，如果攻击者没修改readlinkat的返回值，就可以检测出来 。<br>检测完毕路径以后对这个文件的权限进行反查，正常apk是在系统下的，权限GID和UID应该是1000 ，如果攻击者忘记修改权限也可以检测出来 。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-type">const</span> <span class="hljs-type">char</span> *path = <span class="hljs-built_in">getApkPath</span>(env, context);<br><span class="hljs-comment">//check svc apk sign</span><br><span class="hljs-type">const</span> string &amp;string = <span class="hljs-built_in">checkSign</span>(env, path).<span class="hljs-built_in">substr</span>(<span class="hljs-number">0</span>, <span class="hljs-number">10</span>);<br><span class="hljs-built_in">LOG</span>(INFO) &lt;&lt; <span class="hljs-string">&quot;apk sign  &quot;</span> &lt;&lt; string;<br><span class="hljs-keyword">if</span> (string == Base64Utils::<span class="hljs-built_in">VTDecode</span>(<span class="hljs-string">&quot;TFtCRU58UERAUQ==&quot;</span>)) &#123;<br>    <span class="hljs-comment">//check sign success,but maybe svc io hook</span><br>    <span class="hljs-comment">//check apk path</span><br>    <span class="hljs-type">int</span> fd = <span class="hljs-built_in">my_openat</span>(AT_FDCWD, <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">const</span> <span class="hljs-type">char</span> *&gt;(path),<br>                       O_RDONLY | O_CLOEXEC,<br>                       <span class="hljs-number">0640</span>);<br>    <span class="hljs-comment">//check apk path</span><br>    <span class="hljs-type">char</span> buff[PATH_MAX] = &#123;<span class="hljs-number">0</span>&#125;;<br>    <span class="hljs-function">std::string <span class="hljs-title">fdPath</span><span class="hljs-params">(<span class="hljs-string">&quot;/proc/&quot;</span>)</span></span>;<br>    fdPath.<span class="hljs-built_in">append</span>(<span class="hljs-built_in">to_string</span>(<span class="hljs-built_in">getpid</span>())).<span class="hljs-built_in">append</span>(<span class="hljs-string">&quot;/fd/&quot;</span>).<span class="hljs-built_in">append</span>(<span class="hljs-built_in">to_string</span>(fd));<br>    <span class="hljs-type">long</span> len = <span class="hljs-built_in">raw_syscall</span>(__NR_readlinkat, AT_FDCWD, fdPath.<span class="hljs-built_in">c_str</span>(), buff, PATH_MAX);<br>    <span class="hljs-keyword">if</span> (len &lt; <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">getItemData</span>(env, <span class="hljs-string">&quot;APK签名验证失败&quot;</span>,<br>                           <span class="hljs-string">&quot;readlinkat error&quot;</span>, <span class="hljs-literal">true</span>,<br>                           RISK_LEAVE_DEADLY, TAG_REPACKAGE);<br>    &#125;<br>    <span class="hljs-comment">//截断,如果攻击者hook了readlinkat,只修改了参数,没修改返回值也可以检测出来。</span><br>    buff[len] = <span class="hljs-string">&#x27;\0&#x27;</span>;<br>    <span class="hljs-built_in">LOG</span>(INFO) &lt;&lt; <span class="hljs-string">&quot;check apk sign path &quot;</span> &lt;&lt; buff;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">my_strcmp</span>(path, buff) == <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-built_in">LOG</span>(INFO) &lt;&lt; <span class="hljs-string">&quot;check apk sign path success &quot;</span>;<br>        <span class="hljs-comment">//start check memory&amp;location inode</span><br>        <span class="hljs-keyword">struct</span> <span class="hljs-title class_">stat</span> statBuff = &#123;<span class="hljs-number">0</span>&#125;;<br>        <span class="hljs-type">long</span> stat = <span class="hljs-built_in">raw_syscall</span>(__NR_fstat, fd, &amp;statBuff);<br>        <span class="hljs-keyword">if</span> (stat &lt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-built_in">LOG</span>(ERROR) &lt;&lt; <span class="hljs-string">&quot;check apk sign path fail __NR_fstat&lt;0&quot;</span>;<br>            <span class="hljs-keyword">return</span> <span class="hljs-built_in">getItemData</span>(env, <span class="hljs-string">&quot;APK签名验证失败&quot;</span>,<br>                               <span class="hljs-string">&quot;fstat error&quot;</span>, <span class="hljs-literal">true</span>, RISK_LEAVE_DEADLY, TAG_REPACKAGE);<br>        &#125;<br>        <span class="hljs-comment">//check uid&amp;gid (1000 = system group)</span><br>        <span class="hljs-keyword">if</span> (statBuff.st_uid != <span class="hljs-number">1000</span> &amp;&amp; statBuff.st_gid != <span class="hljs-number">1000</span>) &#123;<br>            <span class="hljs-built_in">LOG</span>(ERROR) &lt;&lt; <span class="hljs-string">&quot;check apk sign gid&amp;uid fail &quot;</span>;<br>            <span class="hljs-keyword">return</span> <span class="hljs-built_in">getItemData</span>(env, <span class="hljs-string">&quot;APK签名验证失败&quot;</span>,<br>                               <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">true</span>, RISK_LEAVE_DEADLY, TAG_REPACKAGE);<br>        &#125;<br>        <span class="hljs-type">size_t</span> inode = <span class="hljs-built_in">getFileInMapsInode</span>(path);<br>        <span class="hljs-keyword">if</span> (statBuff.st_ino != inode) &#123;<br>            <span class="hljs-built_in">LOG</span>(ERROR) &lt;&lt; <span class="hljs-string">&quot;check apk sign inode fail &quot;</span>&lt;&lt;statBuff.st_ino&lt;&lt;<span class="hljs-string">&quot; maps -&gt;&quot;</span>&lt;&lt;inode;<br>            <span class="hljs-keyword">return</span> <span class="hljs-built_in">getItemData</span>(env, <span class="hljs-string">&quot;APK签名验证失败&quot;</span>,<br>                               <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">true</span>, RISK_LEAVE_DEADLY, TAG_REPACKAGE);<br>        &#125;<br>        <span class="hljs-built_in">LOG</span>(ERROR) &lt;&lt; <span class="hljs-string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; check apk sign success! uid-&gt; &quot;</span> &lt;&lt; statBuff.st_uid<br>                   &lt;&lt; <span class="hljs-string">&quot; gid-&gt; &quot;</span><br>                   &lt;&lt; statBuff.st_gid;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-built_in">LOG</span>(ERROR) &lt;&lt; <span class="hljs-string">&quot;check apk sign path fail &quot;</span>;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">getItemData</span>(env, <span class="hljs-string">&quot;APK签名验证失败&quot;</span>,<br>                           <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">true</span>, RISK_LEAVE_DEADLY, TAG_REPACKAGE);<br> <br>    &#125;<br>    <span class="hljs-built_in">LOG</span>(INFO) &lt;&lt; <span class="hljs-string">&quot;check apk sign success&quot;</span>;<br> <br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>对抗：<br>针对上面的检测对抗也很简单，对svc的openat拦截了以后，对readlinkat和stat函数进行处理即可 。很轻松即可绕过检测 。很多加壳基本都是检测ROOT检测LSP调用栈之类的 ，并不只是单一的去检测签名一个纬度 。比如发现了开启了seccomp就会闪退，发现Root就会闪退 。</p>
<p>Java层获取签名方法：<br>检测：<br>检测CREATOR是否被替换<br>这里先说一下Hunter的Java层检测签名的方法，这块相当于反射CREATOR 变量，这个变量是保存一些IPC通讯的东西 。</p>
<p>很多攻击者会用Lspatch进行打包 ，对变量进行替换，这时候我们去检测这个变量的Classloader是不是系统ClassLoader 。</p>
<p>防止被替换 。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">try</span> &#123;<br>    <span class="hljs-type">Field</span> <span class="hljs-variable">creatorField</span> <span class="hljs-operator">=</span> PackageInfo.class.getField(<span class="hljs-string">&quot;CREATOR&quot;</span>);<br>    creatorField.setAccessible(<span class="hljs-literal">true</span>);<br>    <span class="hljs-type">Object</span> <span class="hljs-variable">creator</span> <span class="hljs-operator">=</span> creatorField.get(<span class="hljs-literal">null</span>);<br>    <span class="hljs-keyword">if</span> (creator != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-type">ClassLoader</span> <span class="hljs-variable">creatorClassloader</span> <span class="hljs-operator">=</span> creator.getClass().getClassLoader();<br>        <span class="hljs-type">ClassLoader</span> <span class="hljs-variable">sysClassloader</span> <span class="hljs-operator">=</span> ClassLoader.getSystemClassLoader();<br>        <span class="hljs-keyword">if</span> (creatorClassloader == <span class="hljs-literal">null</span> || sysClassloader == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br>        <span class="hljs-comment">//系统的是bootclassloader</span><br>        <span class="hljs-comment">//用户创建的都是pathclassloader</span><br>        <span class="hljs-comment">//如果相等则认为系统的被替换</span><br>        <span class="hljs-keyword">if</span> (sysClassloader.getClass().getName().<br>                equals(creatorClassloader.getClass().getName())) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ListItemBean</span>(<span class="hljs-string">&quot;Apk签名验证失败！&quot;</span>,<br>                    ListItemBean.RiskLeave.Deadly,<br>                    <span class="hljs-string">&quot;Apk签名方法被替换!\n&quot;</span><br>                            + creatorClassloader.getClass().getName() + <span class="hljs-string">&quot;\n&quot;</span><br>                            + sysClassloader.getClass().getName());<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>&#125; <span class="hljs-keyword">catch</span> (Throwable e) &#123;<br>    CLog.e(<span class="hljs-string">&quot;checkApkPackageInfoCreator error &quot;</span> + e);<br>&#125;<br></code></pre></td></tr></table></figure>
<p>对抗：<br>对抗的方法主要下面三种：</p>
<p>现在大厂一般会直接通过IPC直接和PMS进行通讯 ，不过这种思路也很好过 ，我这边也是参考的Lspatch 。</p>
<p>这块有两个很核心的思路 ，就是拦截Binder IPC通讯的方法，和Hook 服务端的签名解析方法 。代码如下：</p>
<p>Hook服务端解析签名方法<br>在系统进行签名解析的时候进行签名替换替换 。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">hookPackageParser</span><span class="hljs-params">(Signature[] fakeSignature)</span> &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>        RposedBridge.hookAllMethods(<br>                RposedHelpers.findClass(<span class="hljs-string">&quot;android.content.pm.PackageParser&quot;</span>, ClassLoader.getSystemClassLoader()),<br>                <span class="hljs-string">&quot;generatePackageInfo&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">RC_MethodHook</span>() &#123;<br>                    <span class="hljs-meta">@Override</span><br>                    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">afterHookedMethod</span><span class="hljs-params">(MethodHookParam param)</span> &#123;<br>                        <span class="hljs-type">PackageInfo</span> <span class="hljs-variable">packageInfo</span> <span class="hljs-operator">=</span> (PackageInfo) param.getResult();<br>                        <span class="hljs-keyword">if</span> (packageInfo == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span>;<br>                        <span class="hljs-keyword">if</span> (packageInfo.packageName.equals(RuntimeToolKit.packageName)) &#123;<br>                            <span class="hljs-keyword">if</span> (packageInfo.signatures != <span class="hljs-literal">null</span> &amp;&amp; packageInfo.signatures.length &gt; <span class="hljs-number">0</span>) &#123;<br>                                CLog.i(<span class="hljs-string">&quot;PackageParser signature info (method 1)&quot;</span>);<br>                                packageInfo.signatures[<span class="hljs-number">0</span>] = fakeSignature[<span class="hljs-number">0</span>];<br>                            &#125;<br>                            <span class="hljs-keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.P) &#123;<br>                                <span class="hljs-keyword">if</span> (packageInfo.signingInfo != <span class="hljs-literal">null</span>) &#123;<br>                                    CLog.i(<span class="hljs-string">&quot;PackageParser signature info (method 2)&quot;</span>);<br>                                    Signature[] signaturesArray = packageInfo.signingInfo.getApkContentsSigners();<br>                                    <span class="hljs-keyword">if</span> (signaturesArray != <span class="hljs-literal">null</span> &amp;&amp; signaturesArray.length &gt; <span class="hljs-number">0</span>) &#123;<br>                                        signaturesArray[<span class="hljs-number">0</span>] = fakeSignature[<span class="hljs-number">0</span>];<br>                                    &#125;<br>                                &#125;<br>                            &#125;<br>                        &#125;<br>                    &#125;<br>                &#125;);<br>    &#125; <span class="hljs-keyword">catch</span> (Throwable e) &#123;<br>        CLog.e(<span class="hljs-string">&quot;hook apkSign PackageParser -&gt; generatePackageInfo &quot;</span> + e.getMessage());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>替换CREATOR<br>这个思路也是抄的lspatch ，这种思路可以通过检测CREATOR 变量Classloader的方式检测出来 。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">byPassSignatureForCREATOR</span><span class="hljs-params">(Signature[] fakeSignature)</span> &#123;<br>    <span class="hljs-keyword">if</span> (fakeSignature == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br>    Parcelable.Creator&lt;PackageInfo&gt; originalCreator = PackageInfo.CREATOR;<br>    Parcelable.Creator&lt;PackageInfo&gt; proxiedCreator = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Parcelable</span>.Creator&lt;PackageInfo&gt;() &#123;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> PackageInfo <span class="hljs-title function_">createFromParcel</span><span class="hljs-params">(Parcel source)</span> &#123;<br>            <span class="hljs-type">PackageInfo</span> <span class="hljs-variable">packageInfo</span> <span class="hljs-operator">=</span> originalCreator.createFromParcel(source);<br>            <span class="hljs-keyword">if</span> (packageInfo.packageName.equals(RuntimeToolKit.packageName)) &#123;<br>                <span class="hljs-keyword">if</span> (packageInfo.signatures != <span class="hljs-literal">null</span> &amp;&amp; packageInfo.signatures.length &gt; <span class="hljs-number">0</span>) &#123;<br>                    <span class="hljs-comment">//CLog.i(&quot;CREATOR Replace signature info (method 1)&quot;);</span><br>                    packageInfo.signatures[<span class="hljs-number">0</span>] = fakeSignature[<span class="hljs-number">0</span>];<br>                &#125;<br>                <span class="hljs-keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.P) &#123;<br>                    <span class="hljs-keyword">if</span> (packageInfo.signingInfo != <span class="hljs-literal">null</span>) &#123;<br>                        <span class="hljs-comment">//CLog.i(&quot;CREATOR Replace signature info (method 2)&quot;);</span><br>                        Signature[] signaturesArray = packageInfo.signingInfo.getApkContentsSigners();<br>                        <span class="hljs-keyword">if</span> (signaturesArray != <span class="hljs-literal">null</span> &amp;&amp; signaturesArray.length &gt; <span class="hljs-number">0</span>) &#123;<br>                            signaturesArray[<span class="hljs-number">0</span>] = fakeSignature[<span class="hljs-number">0</span>];<br>                        &#125;<br>                    &#125;<br>                &#125;<br>            &#125;<br>            <span class="hljs-keyword">return</span> packageInfo;<br>        &#125;<br> <br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> PackageInfo[] newArray(<span class="hljs-type">int</span> size) &#123;<br>            <span class="hljs-keyword">return</span> originalCreator.newArray(size);<br>        &#125;<br>    &#125;;<br>    RposedHelpers.setStaticObjectField(PackageInfo.class, <span class="hljs-string">&quot;CREATOR&quot;</span>, proxiedCreator);<br>    <span class="hljs-keyword">try</span> &#123;<br>        Map&lt;?, ?&gt; mCreators = (Map&lt;?, ?&gt;) RposedHelpers.getStaticObjectField(Parcel.class, <span class="hljs-string">&quot;mCreators&quot;</span>);<br>        mCreators.clear();<br>    &#125; <span class="hljs-keyword">catch</span> (NoSuchFieldError ignore) &#123;<br>    &#125; <span class="hljs-keyword">catch</span> (Throwable e) &#123;<br>        CLog.e(<span class="hljs-string">&quot;fail to clear Parcel.mCreators&quot;</span>, e);<br>    &#125;<br>    <span class="hljs-keyword">try</span> &#123;<br>        Map&lt;?, ?&gt; sPairedCreators = (Map&lt;?, ?&gt;)<br>                RposedHelpers.getStaticObjectField(Parcel.class,<br>                        <span class="hljs-string">&quot;sPairedCreators&quot;</span>);<br>        sPairedCreators.clear();<br>    &#125; <span class="hljs-keyword">catch</span> (NoSuchFieldError ignore) &#123;<br>    &#125; <span class="hljs-keyword">catch</span> (Throwable e) &#123;<br>        CLog.e(<span class="hljs-string">&quot;fail to clear Parcel.sPairedCreators&quot;</span>, e);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>Binder transact 方法<br>有很多大厂会自己伪造IPC和服务端进行通讯，用这种方法可以进行签名的修改和替换，实现思路主要就是Hook binder通讯解析的方法 。判断如果传输类型数据是获取签名的话就进行替换 。主要思路就是Hook传输数据的“水管”，对水管里面的内容进行替换 。</p>
<p>不知道为什么lspatch新版本把这段代码删除了 ，只采用了替换CREATOR 和Hook服务端解析签名的方法 。</p>
<p>代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><code class="hljs java">RposedHelpers.findAndHookMethod(<span class="hljs-string">&quot;android.os.BinderProxy&quot;</span>,<br>        context.getClassLoader(),<br>        <span class="hljs-string">&quot;transact&quot;</span>,<br>        <span class="hljs-type">int</span>.class,<br>        Parcel.class,<br>        Parcel.class,<br>        <span class="hljs-type">int</span>.class,<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">RC_MethodHook</span>() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">afterHookedMethod</span><span class="hljs-params">(MethodHookParam param)</span> &#123;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    <span class="hljs-type">Object</span> <span class="hljs-variable">object</span> <span class="hljs-operator">=</span> param.thisObject;<br>                    <span class="hljs-type">int</span> <span class="hljs-variable">id</span> <span class="hljs-operator">=</span> (<span class="hljs-type">int</span>) param.args[<span class="hljs-number">0</span>];<br>                    <span class="hljs-type">Parcel</span> <span class="hljs-variable">write</span> <span class="hljs-operator">=</span> (Parcel) param.args[<span class="hljs-number">1</span>];<br>                    <span class="hljs-type">Parcel</span> <span class="hljs-variable">out</span> <span class="hljs-operator">=</span> (Parcel) param.args[<span class="hljs-number">2</span>];<br>                    <span class="hljs-comment">// forward check</span><br>                    <span class="hljs-keyword">if</span> (write == <span class="hljs-literal">null</span> || out == <span class="hljs-literal">null</span>) &#123;<br>                        <span class="hljs-keyword">return</span>;<br>                    &#125;<br>                    <span class="hljs-comment">// prevent recurise call (防止递归)</span><br>                    <span class="hljs-keyword">if</span> (id == IBinder.INTERFACE_TRANSACTION) &#123;<br>                        <span class="hljs-comment">//IBinder协议事务代码：询问事务的收件人端以获取其规范接口描述符。</span><br>                        <span class="hljs-keyword">return</span>;<br>                    &#125;<br> <br>                    <span class="hljs-type">String</span> <span class="hljs-variable">desc</span> <span class="hljs-operator">=</span> (String) RposedHelpers.callMethod(object, <span class="hljs-string">&quot;getInterfaceDescriptor&quot;</span>);<br>                    <span class="hljs-keyword">if</span> (desc == <span class="hljs-literal">null</span> || !desc.equals(<span class="hljs-string">&quot;android.content.pm.IPackageManager&quot;</span>)) &#123;<br>                        <span class="hljs-keyword">return</span>;<br>                    &#125;<br>                    <span class="hljs-keyword">if</span> (id == TRANSACTION_getPackageInfo_ID) &#123;<br>                        out.readException();<br>                        <span class="hljs-keyword">if</span> (<span class="hljs-number">0</span> != out.readInt()) &#123;<br>                            <span class="hljs-type">PackageInfo</span> <span class="hljs-variable">packageInfo</span> <span class="hljs-operator">=</span> PackageInfo.CREATOR.createFromParcel(out);<br>                            <span class="hljs-keyword">if</span> (packageInfo.packageName.equals(context.getApplicationInfo().packageName)) &#123;<br>                                <span class="hljs-keyword">if</span> (fakeSignature[<span class="hljs-number">0</span>] == <span class="hljs-literal">null</span>) &#123;<br>                                    CLog.e(<span class="hljs-string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; byPassSignature fakeSignature == null&quot;</span>);<br>                                    System.exit(<span class="hljs-number">0</span>);<br>                                    <span class="hljs-keyword">return</span>;<br>                                &#125;<br>                                <span class="hljs-comment">//CLog.i( &quot;org data size -&gt;  &quot;+out.dataSize());</span><br> <br>                                <span class="hljs-keyword">if</span> (packageInfo.signatures != <span class="hljs-literal">null</span> &amp;&amp; packageInfo.signatures.length &gt; <span class="hljs-number">0</span>) &#123;<br>                                    packageInfo.signatures[<span class="hljs-number">0</span>] = fakeSignature[<span class="hljs-number">0</span>];<br>                                    <span class="hljs-comment">//CLog.i(&quot; byPassSignatureByLSPosed 1 !!&quot;);</span><br>                                &#125;<br>                                <span class="hljs-keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.P) &#123;<br>                                    <span class="hljs-keyword">if</span> (packageInfo.signingInfo != <span class="hljs-literal">null</span>) &#123;<br>                                        Signature[] signaturesArray = packageInfo.signingInfo.getApkContentsSigners();<br>                                        <span class="hljs-keyword">if</span> (signaturesArray != <span class="hljs-literal">null</span> &amp;&amp; signaturesArray.length &gt; <span class="hljs-number">0</span>) &#123;<br>                                            signaturesArray[<span class="hljs-number">0</span>] = fakeSignature[<span class="hljs-number">0</span>];<br>                                            <span class="hljs-comment">//CLog.i( &quot; byPassSignatureByLSPosed 2 !!&quot;);</span><br>                                        &#125;<br>                                    &#125;<br>                                &#125;<br> <br>                                out.setDataPosition(<span class="hljs-number">0</span>);<br>                                out.setDataSize(<span class="hljs-number">0</span>);<br>                                out.writeNoException();<br>                                out.writeInt(<span class="hljs-number">1</span>);<br>                                packageInfo.writeToParcel(out, PARCELABLE_WRITE_RETURN_VALUE);<br>                            &#125;<br>                        &#125;<br> <br>                        <span class="hljs-comment">// reset pos</span><br>                        out.setDataPosition(<span class="hljs-number">0</span>);<br>                    &#125;<br>                &#125;<br>                <span class="hljs-keyword">catch</span> (Throwable err) &#123;<br>                    CLog.e(<span class="hljs-string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; byPassSignatureByLSPosed error &quot;</span> + err.getMessage());<br>                &#125;<br>            &#125;<br>        &#125;);<br></code></pre></td></tr></table></figure>

<p>还有很多很好思路的代码 ，比如ISO线程去读取apk签名信息，防止SVC被IO重定向掉 。</p>
<p>当然检测签名的方法肯定不止这些，如果有更好的，我没写的，也可以在文章下面留言 。</p>
<p>模拟器检测：<br>Java层基础的获取api架构啥的，这块就不一一叙述了 。</p>
<p>Seccomp检测架构：<br>主要思路来自B哥 ，感谢B个 ，先安装seccomp架子 。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">install_check_arch_seccomp</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">sock_filter</span> filter[<span class="hljs-number">15</span>] = &#123;<br>            <span class="hljs-built_in">BPF_STMT</span>(BPF_LD + BPF_W + BPF_ABS, (<span class="hljs-type">uint32_t</span>) <span class="hljs-built_in">offsetof</span>(<span class="hljs-keyword">struct</span> seccomp_data, nr)),<br>            <span class="hljs-built_in">BPF_JUMP</span>(BPF_JMP + BPF_JEQ, __NR_getpid, <span class="hljs-number">0</span>, <span class="hljs-number">12</span>),<br>            <span class="hljs-built_in">BPF_STMT</span>(BPF_LD + BPF_W + BPF_ABS, (<span class="hljs-type">uint32_t</span>) <span class="hljs-built_in">offsetof</span>(<span class="hljs-keyword">struct</span> seccomp_data, args[<span class="hljs-number">0</span>])),<br>            <span class="hljs-built_in">BPF_JUMP</span>(BPF_JMP + BPF_JEQ, DetectX86Flag, <span class="hljs-number">0</span>, <span class="hljs-number">10</span>),<br>            <span class="hljs-built_in">BPF_STMT</span>(BPF_LD + BPF_W + BPF_ABS, (<span class="hljs-type">uint32_t</span>) <span class="hljs-built_in">offsetof</span>(<span class="hljs-keyword">struct</span> seccomp_data, arch)),<br>            <span class="hljs-built_in">BPF_JUMP</span>(BPF_JMP + BPF_JEQ, AUDIT_ARCH_X86_64, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>),<br>            <span class="hljs-built_in">BPF_STMT</span>(BPF_RET + BPF_K, SECCOMP_RET_ERRNO | (<span class="hljs-number">864</span> &amp; SECCOMP_RET_DATA)),<br>            <span class="hljs-built_in">BPF_JUMP</span>(BPF_JMP + BPF_JEQ, AUDIT_ARCH_I386, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>),<br>            <span class="hljs-built_in">BPF_STMT</span>(BPF_RET + BPF_K, SECCOMP_RET_ERRNO | (<span class="hljs-number">386</span> &amp; SECCOMP_RET_DATA)),<br>            <span class="hljs-built_in">BPF_JUMP</span>(BPF_JMP + BPF_JEQ, AUDIT_ARCH_ARM, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>),<br>            <span class="hljs-built_in">BPF_STMT</span>(BPF_RET + BPF_K, SECCOMP_RET_ERRNO | (<span class="hljs-number">0xA32</span> &amp; SECCOMP_RET_DATA)),<br>            <span class="hljs-built_in">BPF_JUMP</span>(BPF_JMP + BPF_JEQ, AUDIT_ARCH_AARCH64, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>),<br>            <span class="hljs-built_in">BPF_STMT</span>(BPF_RET + BPF_K, SECCOMP_RET_ERRNO | (<span class="hljs-number">0xA64</span> &amp; SECCOMP_RET_DATA)),<br>            <span class="hljs-built_in">BPF_STMT</span>(BPF_RET + BPF_K, SECCOMP_RET_ERRNO | (<span class="hljs-number">6</span> &amp; SECCOMP_RET_DATA)),<br>            <span class="hljs-built_in">BPF_STMT</span>(BPF_RET + BPF_K, SECCOMP_RET_ALLOW)<br> <br>    &#125;;<br>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">sock_fprog</span> program = &#123;<br>            .len = (<span class="hljs-type">unsigned</span> <span class="hljs-type">short</span>) (<span class="hljs-built_in">sizeof</span>(filter) / <span class="hljs-built_in">sizeof</span>(filter[<span class="hljs-number">0</span>])),<br>            .filter = filter<br>    &#125;;<br>    errno = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">prctl</span>(PR_SET_NO_NEW_PRIVS, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>)) &#123;<br>        <span class="hljs-built_in">LOG</span>(ERROR) &lt;&lt; <span class="hljs-string">&quot;prctl(PR_SET_NO_NEW_PRIVS) &quot;</span> &lt;&lt; <span class="hljs-built_in">strerror</span>(errno);<br>    &#125;<br>    errno = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">prctl</span>(PR_SET_SECCOMP, SECCOMP_MODE_FILTER, &amp;program)) &#123;<br>        <span class="hljs-built_in">LOG</span>(ERROR) &lt;&lt; <span class="hljs-string">&quot;prctl(PR_SET_SECCOMP) &quot;</span> &lt;&lt; <span class="hljs-built_in">strerror</span>(errno);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>
<p>配合上面的代码 。启动调用getpid， 上面的架子会对getpid函数进行拦截 ，然后架构进行判断 。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function">string <span class="hljs-title">check_arch_by_seccomp</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">get_sdk_level</span>() &lt; __ANDROID_API_N_MR1__)&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>;<br>    &#125;<br>    errno = <span class="hljs-number">0</span>;<br>    <span class="hljs-built_in">syscall</span>(__NR_getpid, DetectX86Flag);<br>    <span class="hljs-keyword">if</span> (errno == <span class="hljs-number">386</span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;I386设备&quot;</span>;<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (errno == <span class="hljs-number">864</span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;X86_64设备&quot;</span>;<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (errno == <span class="hljs-number">0xA32</span> || errno == <span class="hljs-number">0xA64</span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>;<br>    &#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (errno == <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-comment">//可能是没有开启seccomp</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> (<span class="hljs-string">&quot;疑似X86模拟器设备&quot;</span>+ <span class="hljs-built_in">to_string</span>(errno));<br>&#125;<br></code></pre></td></tr></table></figure>
<p>检测温度挂载文件：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">thermal_check</span><span class="hljs-params">()</span> </span>&#123;<br>    DIR *dir_ptr;<br>    <span class="hljs-type">int</span> count = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">dirent</span> *entry;<br>    <span class="hljs-keyword">if</span> ((dir_ptr = <span class="hljs-built_in">opendir</span>(<span class="hljs-string">&quot;/sys/class/thermal/&quot;</span>)) != <span class="hljs-literal">nullptr</span>) &#123;<br>        <span class="hljs-keyword">while</span> ((entry = <span class="hljs-built_in">readdir</span>(dir_ptr))) &#123;<br>            <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">strcmp</span>(entry-&gt;d_name, <span class="hljs-string">&quot;.&quot;</span>) || !<span class="hljs-built_in">strcmp</span>(entry-&gt;d_name, <span class="hljs-string">&quot;..&quot;</span>)) &#123;<br>                <span class="hljs-keyword">continue</span>;<br>            &#125;<br>            <span class="hljs-type">char</span> *tmp = entry-&gt;d_name;<br>            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strstr</span>(tmp, <span class="hljs-string">&quot;thermal_zone&quot;</span>) != <span class="hljs-literal">nullptr</span>) &#123;<br>                count++;<br>            &#125;<br>        &#125;<br>        <span class="hljs-built_in">closedir</span>(dir_ptr);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        count = <span class="hljs-number">-1</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> count;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>模拟器特征文件：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function">string <span class="hljs-title">simulator_files_check</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">file_exist</span>(<span class="hljs-string">&quot;/system/bin/androVM-prop&quot;</span>)) &#123;<span class="hljs-comment">//检测androidVM</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;/system/bin/androVM-prop&quot;</span>;<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">file_exist</span>(<span class="hljs-string">&quot;/system/bin/microvirt-prop&quot;</span>)) &#123;<span class="hljs-comment">//检测逍遥模拟器--新版本找不到特征</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;/system/bin/microvirt-prop&quot;</span>;<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">file_exist</span>(<span class="hljs-string">&quot;/system/lib/libdroid4x.so&quot;</span>)) &#123;<span class="hljs-comment">//检测海马模拟器</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;/system/lib/libdroid4x.so&quot;</span>;<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">file_exist</span>(<span class="hljs-string">&quot;/system/bin/windroyed&quot;</span>)) &#123;<span class="hljs-comment">//检测文卓爷模拟器</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;/system/bin/windroyed&quot;</span>;<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">file_exist</span>(<span class="hljs-string">&quot;/system/bin/nox-prop&quot;</span>)) &#123;<span class="hljs-comment">//检测夜神模拟器--某些版本找不到特征</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;/system/bin/nox-prop&quot;</span>;<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">file_exist</span>(<span class="hljs-string">&quot;system/lib/libnoxspeedup.so&quot;</span>)) &#123;<span class="hljs-comment">//检测夜神模拟器</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;system/lib/libnoxspeedup.so&quot;</span>;<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">file_exist</span>(<span class="hljs-string">&quot;/system/bin/ttVM-prop&quot;</span>)) &#123;<span class="hljs-comment">//检测天天模拟器</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;/system/bin/ttVM-prop&quot;</span>;<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">file_exist</span>(<span class="hljs-string">&quot;/data/.bluestacks.prop&quot;</span>)) &#123;<span class="hljs-comment">//检测bluestacks模拟器  51模拟器</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;/data/.bluestacks.prop&quot;</span>;<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">file_exist</span>(<span class="hljs-string">&quot;/system/bin/duosconfig&quot;</span>)) &#123;<span class="hljs-comment">//检测AMIDuOS模拟器</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;/system/bin/duosconfig&quot;</span>;<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">file_exist</span>(<span class="hljs-string">&quot;/system/etc/xxzs_prop.sh&quot;</span>)) &#123;<span class="hljs-comment">//检测星星模拟器</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;/system/etc/xxzs_prop.sh&quot;</span>;<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">file_exist</span>(<span class="hljs-string">&quot;/system/etc/mumu-configs/device-prop-configs/mumu.config&quot;</span>)) &#123;<span class="hljs-comment">//网易MuMu模拟器</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;/system/etc/mumu-configs/device-prop-configs/mumu.config&quot;</span>;<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">file_exist</span>(<span class="hljs-string">&quot;/system/priv-app/ldAppStore&quot;</span>)) &#123;<span class="hljs-comment">//雷电模拟器</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;/system/priv-app/ldAppStore&quot;</span>;<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">file_exist</span>(<span class="hljs-string">&quot;system/bin/ldinit&quot;</span>) &amp;&amp; <span class="hljs-built_in">file_exist</span>(<span class="hljs-string">&quot;system/bin/ldmountsf&quot;</span>)) &#123;<span class="hljs-comment">//雷电模拟器</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;system/bin/ldinit&quot;</span>;<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">file_exist</span>(<span class="hljs-string">&quot;/system/app/AntStore&quot;</span>) &amp;&amp; <span class="hljs-built_in">file_exist</span>(<span class="hljs-string">&quot;/system/app/AntLauncher&quot;</span>)) &#123;<span class="hljs-comment">//小蚁模拟器</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;/system/app/AntStore&quot;</span>;<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">file_exist</span>(<span class="hljs-string">&quot;vmos.prop&quot;</span>)) &#123;<span class="hljs-comment">//vmos虚拟机</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;vmos.prop&quot;</span>;<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">file_exist</span>(<span class="hljs-string">&quot;fstab.titan&quot;</span>) &amp;&amp; <span class="hljs-built_in">file_exist</span>(<span class="hljs-string">&quot;init.titan.rc&quot;</span>)) &#123;<span class="hljs-comment">//光速虚拟机</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;fstab.titan&quot;</span>;<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">file_exist</span>(<span class="hljs-string">&quot;x8.prop&quot;</span>)) &#123;<span class="hljs-comment">//x8沙箱和51虚拟机</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;x8.prop&quot;</span>;<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">file_exist</span>(<span class="hljs-string">&quot;/system/lib/libc_malloc_debug_qemu.so&quot;</span>)) &#123;<span class="hljs-comment">//AVD QEMU</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;/system/lib/libc_malloc_debug_qemu.so&quot;</span>;<br>    &#125;<br>    <span class="hljs-built_in">LOGD</span>(<span class="hljs-string">&quot;simulator file check info not find  &quot;</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>模拟器基础特征：<br>这块思路主要来自非虫 ，在次感谢 。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br></pre></td><td class="code"><pre><code class="hljs java">      <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ListItemBean <span class="hljs-title function_">checkEmulator</span><span class="hljs-params">(Context context)</span> &#123;<br>        ArrayList&lt;String&gt; choose = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br><span class="hljs-comment">//        try &#123;</span><br><span class="hljs-comment">//            String[] strArr = &#123;</span><br><span class="hljs-comment">//                    &quot;/boot/bstmods/vboxguest.ko&quot;,</span><br><span class="hljs-comment">//                    &quot;/boot/bstmods/vboxsf.ko&quot;,</span><br><span class="hljs-comment">//                    &quot;/dev/mtp_usb&quot;,</span><br><span class="hljs-comment">//                    &quot;/dev/qemu_pipe&quot;,</span><br><span class="hljs-comment">//                    &quot;/dev/socket/baseband_genyd&quot;,</span><br><span class="hljs-comment">//                    &quot;/dev/socket/genyd&quot;,</span><br><span class="hljs-comment">//                    &quot;/dev/socket/qemud&quot;,</span><br><span class="hljs-comment">//                    &quot;/dev/socket/windroyed-audio&quot;,</span><br><span class="hljs-comment">//                    &quot;/dev/socket/windroyed-camera&quot;,</span><br><span class="hljs-comment">//                    &quot;/dev/socket/windroyed-gps&quot;,</span><br><span class="hljs-comment">//                    &quot;/dev/socket/windroyed-sensors&quot;,</span><br><span class="hljs-comment">//                    &quot;/dev/vboxguest&quot;,</span><br><span class="hljs-comment">//                    &quot;/dev/vboxpci&quot;,</span><br><span class="hljs-comment">//                    &quot;/dev/vboxuser&quot;,</span><br><span class="hljs-comment">//                    &quot;/fstab.goldfish&quot;,</span><br><span class="hljs-comment">//                    &quot;/fstab.nox&quot;,</span><br><span class="hljs-comment">//                    &quot;/fstab.ranchu-encrypt&quot;,</span><br><span class="hljs-comment">//                    &quot;/fstab.ranchu-noencrypt&quot;,</span><br><span class="hljs-comment">//                    &quot;/fstab.ttVM_x86&quot;,</span><br><span class="hljs-comment">//                    &quot;/fstab.vbox86&quot;,</span><br><span class="hljs-comment">//                    &quot;/init.goldfish.rc&quot;,</span><br><span class="hljs-comment">//                    &quot;/init.magisk.rc&quot;,</span><br><span class="hljs-comment">//                    &quot;/init.nox.rc&quot;,</span><br><span class="hljs-comment">//                    &quot;/init.ranchu-encrypt.rc&quot;,</span><br><span class="hljs-comment">//                    &quot;/init.ranchu-noencrypt.rc&quot;,</span><br><span class="hljs-comment">//                    &quot;/init.ranchu.rc&quot;,</span><br><span class="hljs-comment">//                    &quot;/init.ttVM_x86.rc&quot;,</span><br><span class="hljs-comment">//                    &quot;/init.vbox86.rc&quot;,</span><br><span class="hljs-comment">//                    &quot;/init.vbox86p.rc&quot;,</span><br><span class="hljs-comment">//                    &quot;/init.windroye.rc&quot;,</span><br><span class="hljs-comment">//                    &quot;/init.windroye.sh&quot;,</span><br><span class="hljs-comment">//                    &quot;/init.x86.rc&quot;,</span><br><span class="hljs-comment">//                    &quot;/proc/irq/20/vboxguest&quot;,</span><br><span class="hljs-comment">//                    &quot;/sdcard/Android/data/com.redfinger.gamemanage&quot;,</span><br><span class="hljs-comment">//                    &quot;/stab.andy&quot;,</span><br><span class="hljs-comment">//                    &quot;/sys/bus/pci/drivers/vboxguest&quot;,</span><br><span class="hljs-comment">//                    &quot;/sys/bus/pci/drivers/vboxpci&quot;,</span><br><span class="hljs-comment">//                    &quot;/sys/bus/platform/drivers/qemu_pipe&quot;,</span><br><span class="hljs-comment">//                    &quot;/sys/bus/platform/drivers/qemu_pipe/qemu_pipe&quot;,</span><br><span class="hljs-comment">//                    &quot;/sys/bus/platform/drivers/qemu_trace&quot;,</span><br><span class="hljs-comment">//                    &quot;/sys/bus/virtio/drivers/itolsvmlgtp&quot;,</span><br><span class="hljs-comment">//                    &quot;/sys/bus/virtio/drivers/itoolsvmhft&quot;,</span><br><span class="hljs-comment">//                    &quot;/sys/class/bdi/vboxsf-1&quot;,</span><br><span class="hljs-comment">//                    &quot;/sys/class/bdi/vboxsf-2&quot;,</span><br><span class="hljs-comment">//                    &quot;/sys/class/bdi/vboxsf-3&quot;,</span><br><span class="hljs-comment">//                    &quot;/sys/class/misc/qemu_pipe&quot;,</span><br><span class="hljs-comment">//                    &quot;/sys/class/misc/vboxguest&quot;,</span><br><span class="hljs-comment">//                    &quot;/sys/class/misc/vboxuser&quot;,</span><br><span class="hljs-comment">//                    &quot;/sys/devices/platform/qemu_pipe&quot;,</span><br><span class="hljs-comment">//                    &quot;/sys/devices/virtual/bdi/vboxsf-1&quot;,</span><br><span class="hljs-comment">//                    &quot;/sys/devices/virtual/bdi/vboxsf-2&quot;,</span><br><span class="hljs-comment">//                    &quot;/sys/devices/virtual/bdi/vboxsf-3&quot;,</span><br><span class="hljs-comment">//                    &quot;/sys/devices/virtual/misc/qemu_pipe&quot;,</span><br><span class="hljs-comment">//                    &quot;/sys/devices/virtual/misc/vboxguest&quot;,</span><br><span class="hljs-comment">//                    &quot;/sys/devices/virtual/misc/vboxpci&quot;,</span><br><span class="hljs-comment">//                    &quot;/sys/devices/virtual/misc/vboxuser&quot;,</span><br><span class="hljs-comment">//                    &quot;/sys/fs/selinux/booleans/in_qemu&quot;,</span><br><span class="hljs-comment">//                    &quot;/sys/kernel/debug/bdi/vboxsf-1&quot;,</span><br><span class="hljs-comment">//                    &quot;/sys/kernel/debug/bdi/vboxsf-2&quot;,</span><br><span class="hljs-comment">//                    &quot;/sys/kernel/debug/x86&quot;,</span><br><span class="hljs-comment">//                    &quot;/sys/module/qemu_trace_sysfs&quot;,</span><br><span class="hljs-comment">//                    &quot;/sys/module/vboxguest&quot;,</span><br><span class="hljs-comment">//                    &quot;/sys/module/vboxguest/drivers/pci:vboxguest&quot;,</span><br><span class="hljs-comment">//                    &quot;/sys/module/vboxpcism&quot;,</span><br><span class="hljs-comment">//                    &quot;/sys/module/vboxsf&quot;,</span><br><span class="hljs-comment">//                    &quot;/sys/module/vboxvideo&quot;,</span><br><span class="hljs-comment">//                    &quot;/sys/module/virtio_pt/drivers/virtio:itoolsvmhft&quot;,</span><br><span class="hljs-comment">//                    &quot;/sys/module/virtio_pt_ie/drivers/virtio:itoolsvmlgtp&quot;,</span><br><span class="hljs-comment">//                    &quot;/sys/qemu_trace&quot;,</span><br><span class="hljs-comment">//                    &quot;/system/app/GenymotionLayout&quot;,</span><br><span class="hljs-comment">//                    &quot;/system/bin/OpenglService&quot;,</span><br><span class="hljs-comment">//                    &quot;/system/bin/androVM-vbox-sf&quot;,</span><br><span class="hljs-comment">//                    &quot;/system/bin/droid4x&quot;,</span><br><span class="hljs-comment">//                    &quot;/system/bin/droid4x-prop&quot;,</span><br><span class="hljs-comment">//                    &quot;/system/bin/droid4x-vbox-sf&quot;,</span><br><span class="hljs-comment">//                    &quot;/system/bin/droid4x_setprop&quot;,</span><br><span class="hljs-comment">//                    &quot;/system/bin/enable_nox&quot;,</span><br><span class="hljs-comment">//                    &quot;/system/bin/genymotion-vbox-sf&quot;,</span><br><span class="hljs-comment">//                    &quot;/system/bin/microvirt-prop&quot;,</span><br><span class="hljs-comment">//                    &quot;/system/bin/microvirt-vbox-sf&quot;,</span><br><span class="hljs-comment">//                    &quot;/system/bin/microvirt_setprop&quot;,</span><br><span class="hljs-comment">//                    &quot;/system/bin/microvirtd&quot;,</span><br><span class="hljs-comment">//                    &quot;/system/bin/mount.vboxsf&quot;,</span><br><span class="hljs-comment">//                    &quot;/system/bin/nox&quot;,</span><br><span class="hljs-comment">//                    &quot;/system/bin/nox-prop&quot;,</span><br><span class="hljs-comment">//                    &quot;/system/bin/nox-vbox-sf&quot;,</span><br><span class="hljs-comment">//                    &quot;/system/bin/nox_setprop&quot;,</span><br><span class="hljs-comment">//                    &quot;/system/bin/noxd&quot;,</span><br><span class="hljs-comment">//                    &quot;/system/bin/noxscreen&quot;,</span><br><span class="hljs-comment">//                    &quot;/system/bin/noxspeedup&quot;,</span><br><span class="hljs-comment">//                    &quot;/system/bin/qemu-props&quot;,</span><br><span class="hljs-comment">//                    &quot;/system/bin/qemud&quot;,</span><br><span class="hljs-comment">//                    &quot;/system/bin/shellnox&quot;,</span><br><span class="hljs-comment">//                    &quot;/system/bin/ttVM-prop&quot;,</span><br><span class="hljs-comment">//                    &quot;/system/bin/windroyed&quot;,</span><br><span class="hljs-comment">//                    &quot;/system/droid4x&quot;,</span><br><span class="hljs-comment">//                    &quot;/system/etc/init.droid4x.sh&quot;,</span><br><span class="hljs-comment">//                    &quot;/system/etc/init.tiantian.sh&quot;,</span><br><span class="hljs-comment">//                    &quot;/system/lib/egl/libEGL_emulation.so&quot;,</span><br><span class="hljs-comment">//                    &quot;/system/lib/egl/libEGL_tiantianVM.so&quot;,</span><br><span class="hljs-comment">//                    &quot;/system/lib/egl/libEGL_windroye.so&quot;,</span><br><span class="hljs-comment">//                    &quot;/system/lib/egl/libGLESv1_CM_emulation.so&quot;,</span><br><span class="hljs-comment">//                    &quot;/system/lib/egl/libGLESv1_CM_tiantianVM.so&quot;,</span><br><span class="hljs-comment">//                    &quot;/system/lib/egl/libGLESv1_CM_windroye.so&quot;,</span><br><span class="hljs-comment">//                    &quot;/system/lib/egl/libGLESv2_emulation.so&quot;,</span><br><span class="hljs-comment">//                    &quot;/system/lib/egl/libGLESv2_tiantianVM.so&quot;,</span><br><span class="hljs-comment">//                    &quot;/system/lib/egl/libGLESv2_windroye.so&quot;,</span><br><span class="hljs-comment">//                    &quot;/system/lib/hw/audio.primary.vbox86.so&quot;,</span><br><span class="hljs-comment">//                    &quot;/system/lib/hw/audio.primary.windroye.so&quot;,</span><br><span class="hljs-comment">//                    &quot;/system/lib/hw/audio.primary.x86.so&quot;,</span><br><span class="hljs-comment">//                    &quot;/system/lib/hw/autio.primary.nox.so&quot;,</span><br><span class="hljs-comment">//                    &quot;/system/lib/hw/camera.vbox86.so&quot;,</span><br><span class="hljs-comment">//                    &quot;/system/lib/hw/camera.windroye.jpeg.so&quot;,</span><br><span class="hljs-comment">//                    &quot;/system/lib/hw/camera.windroye.so&quot;,</span><br><span class="hljs-comment">//                    &quot;/system/lib/hw/camera.x86.so&quot;,</span><br><span class="hljs-comment">//                    &quot;/system/lib/hw/gps.nox.so&quot;,</span><br><span class="hljs-comment">//                    &quot;/system/lib/hw/gps.vbox86.so&quot;,</span><br><span class="hljs-comment">//                    &quot;/system/lib/hw/gps.windroye.so&quot;,</span><br><span class="hljs-comment">//                    &quot;/system/lib/hw/gralloc.nox.so&quot;,</span><br><span class="hljs-comment">//                    &quot;/system/lib/hw/gralloc.vbox86.so&quot;,</span><br><span class="hljs-comment">//                    &quot;/system/lib/hw/gralloc.windroye.so&quot;,</span><br><span class="hljs-comment">//                    &quot;/system/lib/hw/sensors.nox.so&quot;,</span><br><span class="hljs-comment">//                    &quot;/system/lib/hw/sensors.vbox86.so&quot;,</span><br><span class="hljs-comment">//                    &quot;/system/lib/hw/sensors.windroye.so&quot;,</span><br><span class="hljs-comment">//                    &quot;/system/lib/init.nox.sh&quot;,</span><br><span class="hljs-comment">//                    &quot;/system/lib/libGM_OpenglSystemCommon.so&quot;,</span><br><span class="hljs-comment">//                    &quot;/system/lib/libc_malloc_debug_qemu.so&quot;,</span><br><span class="hljs-comment">//                    &quot;/system/lib/libclcore_x86.bc&quot;,</span><br><span class="hljs-comment">//                    &quot;/system/lib/libdroid4x.so&quot;,</span><br><span class="hljs-comment">//                    &quot;/system/lib/libnoxd.so&quot;,</span><br><span class="hljs-comment">//                    &quot;/system/lib/libnoxspeedup.so&quot;,</span><br><span class="hljs-comment">//                    &quot;/system/lib/modules/3.10.30-android-x86.hd+&quot;,</span><br><span class="hljs-comment">//                    &quot;/system/lib/vboxguest.ko&quot;,</span><br><span class="hljs-comment">//                    &quot;/system/lib/vboxpcism.ko&quot;,</span><br><span class="hljs-comment">//                    &quot;/system/lib/vboxsf.ko&quot;,</span><br><span class="hljs-comment">//                    &quot;/system/lib/vboxvideo.ko&quot;,</span><br><span class="hljs-comment">//                    &quot;/system/lib64/egl/libEGL_emulation.so&quot;,</span><br><span class="hljs-comment">//                    &quot;/system/lib64/egl/libGLESv1_CM_emulation.so&quot;,</span><br><span class="hljs-comment">//                    &quot;/system/lib64/egl/libGLESv2_emulation.so&quot;,</span><br><span class="hljs-comment">//                    &quot;/vendor/lib64/egl/libEGL_emulation.so&quot;,</span><br><span class="hljs-comment">//                    &quot;/vendor/lib64/egl/libGLESv1_CM_emulation.so&quot;,</span><br><span class="hljs-comment">//                    &quot;/vendor/lib64/egl/libGLESv2_emulation.so&quot;,</span><br><span class="hljs-comment">//                    &quot;/vendor/lib64/libandroidemu.so&quot;,</span><br><span class="hljs-comment">//                    &quot;/system/lib64/hw/gralloc.ranchu.so&quot;,</span><br><span class="hljs-comment">//                    &quot;/system/lib64/libc_malloc_debug_qemu.so&quot;,</span><br><span class="hljs-comment">//                    &quot;/system/usr/Keylayout/droid4x_Virtual_Input.kl&quot;,</span><br><span class="hljs-comment">//                    &quot;/system/usr/idc/Genymotion_Virtual_Input.idc&quot;,</span><br><span class="hljs-comment">//                    &quot;/system/usr/idc/droid4x_Virtual_Input.idc&quot;,</span><br><span class="hljs-comment">//                    &quot;/system/usr/idc/nox_Virtual_Input.idc&quot;,</span><br><span class="hljs-comment">//                    &quot;/system/usr/idc/windroye.idc&quot;,</span><br><span class="hljs-comment">//                    &quot;/system/usr/keychars/nox_gpio.kcm&quot;,</span><br><span class="hljs-comment">//                    &quot;/system/usr/keychars/windroye.kcm&quot;,</span><br><span class="hljs-comment">//                    &quot;/system/usr/keylayout/Genymotion_Virtual_Input.kl&quot;,</span><br><span class="hljs-comment">//                    &quot;/system/usr/keylayout/nox_Virtual_Input.kl&quot;,</span><br><span class="hljs-comment">//                    &quot;/system/usr/keylayout/nox_gpio.kl&quot;,</span><br><span class="hljs-comment">//                    &quot;/system/usr/keylayout/windroye.kl&quot;,</span><br><span class="hljs-comment">//                    &quot;system/etc/init/ndk_translation_arm64.rc&quot;,</span><br><span class="hljs-comment">//                    &quot;/system/xbin/noxsu&quot;,</span><br><span class="hljs-comment">//                    &quot;/ueventd.android_x86.rc&quot;,</span><br><span class="hljs-comment">//                    &quot;/ueventd.andy.rc&quot;,</span><br><span class="hljs-comment">//                    &quot;/ueventd.goldfish.rc&quot;,</span><br><span class="hljs-comment">//                    &quot;/ueventd.nox.rc&quot;,</span><br><span class="hljs-comment">//                    &quot;/ueventd.ranchu.rc&quot;,</span><br><span class="hljs-comment">//                    &quot;/ueventd.ttVM_x86.rc&quot;,</span><br><span class="hljs-comment">//                    &quot;/ueventd.vbox86.rc&quot;,</span><br><span class="hljs-comment">//                    &quot;/vendor/lib64/libgoldfish-ril.so&quot;,</span><br><span class="hljs-comment">//                    &quot;/vendor/lib64/libgoldfish_codecs_common.so&quot;,</span><br><span class="hljs-comment">//                    &quot;/vendor/lib64/libstagefright_goldfish_avcdec.so&quot;,</span><br><span class="hljs-comment">//                    &quot;/vendor/lib64/libstagefright_goldfish_vpxdec.so&quot;,</span><br><span class="hljs-comment">//                    &quot;/x86.prop&quot;</span><br><span class="hljs-comment">//            &#125;;</span><br><span class="hljs-comment">//            for (int i = 0; i &lt; 7; i++) &#123;</span><br><span class="hljs-comment">//                String f = strArr[i];</span><br><span class="hljs-comment">//                if (new File(f).exists())</span><br><span class="hljs-comment">//                    choose.add(f);</span><br><span class="hljs-comment">//            &#125;</span><br><span class="hljs-comment">//        &#125; catch (Exception e) &#123;</span><br><span class="hljs-comment">//            e.printStackTrace();</span><br><span class="hljs-comment">//        &#125;</span><br> <br>        <span class="hljs-keyword">try</span> &#123;<br>            String[] myArr = &#123;<br>                    <span class="hljs-string">&quot;generic&quot;</span>,<br>                    <span class="hljs-string">&quot;vbox&quot;</span><br>            &#125;;<br>            <span class="hljs-keyword">for</span> (String str : myArr) &#123;<br>                <span class="hljs-keyword">if</span> (Build.FINGERPRINT.contains(str))<br>                    choose.add(Build.FINGERPRINT);<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>        &#125;<br> <br>        <span class="hljs-keyword">try</span> &#123;<br>            String[] myArr = &#123;<br>                    <span class="hljs-string">&quot;google_sdk&quot;</span>,<br>                    <span class="hljs-string">&quot;emulator&quot;</span>,<br>                    <span class="hljs-string">&quot;android sdk built for&quot;</span>,<br>                    <span class="hljs-string">&quot;droid4x&quot;</span><br>            &#125;;<br>            <span class="hljs-keyword">for</span> (String str : myArr) &#123;<br>                <span class="hljs-keyword">if</span> (Build.MODEL.contains(str))<br>                    choose.add(Build.MODEL);<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>        &#125;<br> <br>        <span class="hljs-keyword">try</span> &#123;<br>            String[] myArr = &#123;<br>                    <span class="hljs-string">&quot;Genymotion&quot;</span><br>            &#125;;<br>            <span class="hljs-keyword">for</span> (String str : myArr) &#123;<br>                <span class="hljs-keyword">if</span> (Build.MANUFACTURER.contains(str))<br>                    choose.add(Build.MANUFACTURER);<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>        &#125;<br> <br>        <span class="hljs-keyword">try</span> &#123;<br>            String[] myArr = &#123;<br>                    <span class="hljs-string">&quot;google_sdk&quot;</span>, <span class="hljs-string">&quot;sdk_phone&quot;</span>, <span class="hljs-string">&quot;sdk_x86&quot;</span>, <span class="hljs-string">&quot;vbox86p&quot;</span>, <span class="hljs-string">&quot;nox&quot;</span><br>            &#125;;<br>            <span class="hljs-keyword">for</span> (String str : myArr) &#123;<br>                <span class="hljs-keyword">if</span> (Build.PRODUCT.toLowerCase(Locale.ROOT).contains(str))<br>                    choose.add(Build.PRODUCT);<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>        &#125;<br> <br>        <span class="hljs-keyword">try</span> &#123;<br>            String[] myArr = &#123;<br>                    <span class="hljs-string">&quot;nox&quot;</span><br>            &#125;;<br>            <span class="hljs-keyword">for</span> (String str : myArr) &#123;<br>                <span class="hljs-keyword">if</span> (Build.BOARD.toLowerCase(Locale.ROOT).contains(str))<br>                    choose.add(Build.BOARD);<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>        &#125;<br> <br>        <span class="hljs-keyword">try</span> &#123;<br>            String[] myArr = &#123;<br>                    <span class="hljs-string">&quot;nox&quot;</span><br>            &#125;;<br>            <span class="hljs-keyword">for</span> (String str : myArr) &#123;<br>                <span class="hljs-keyword">if</span> (Build.BOOTLOADER.toLowerCase(Locale.ROOT).contains(str))<br>                    choose.add(Build.BOOTLOADER);<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>        &#125;<br> <br>        <span class="hljs-keyword">try</span> &#123;<br>            String[] myArr = &#123;<br>                    <span class="hljs-string">&quot;ranchu&quot;</span>, <span class="hljs-string">&quot;vbox86&quot;</span>, <span class="hljs-string">&quot;goldfish&quot;</span><br>            &#125;;<br>            <span class="hljs-keyword">for</span> (String str : myArr) &#123;<br>                <span class="hljs-keyword">if</span> (Build.HARDWARE.equalsIgnoreCase(str))<br>                    choose.add(Build.HARDWARE);<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>        &#125;<br> <br>        <span class="hljs-keyword">try</span> &#123;<br>            Enumeration&lt;NetworkInterface&gt; networkInterfaces = NetworkInterface.getNetworkInterfaces();<br>            <span class="hljs-keyword">while</span> (networkInterfaces.hasMoreElements()) &#123;<br>                <span class="hljs-type">NetworkInterface</span> <span class="hljs-variable">ele</span> <span class="hljs-operator">=</span> networkInterfaces.nextElement();<br>                <span class="hljs-keyword">if</span> (ele != <span class="hljs-literal">null</span>) &#123;<br>                    Enumeration&lt;InetAddress&gt; inetAddresses = ele.getInetAddresses();<br>                    <span class="hljs-keyword">while</span> (inetAddresses.hasMoreElements()) &#123;<br>                        <span class="hljs-type">InetAddress</span> <span class="hljs-variable">nextElement</span> <span class="hljs-operator">=</span> inetAddresses.nextElement();<br>                        <span class="hljs-keyword">if</span> (!nextElement.isLoopbackAddress() &amp;&amp;<br>                                (nextElement <span class="hljs-keyword">instanceof</span> Inet4Address)) &#123;<br>                            <span class="hljs-type">String</span> <span class="hljs-variable">ip</span> <span class="hljs-operator">=</span> nextElement.getHostAddress();<br>                            <span class="hljs-keyword">if</span> (ip == <span class="hljs-literal">null</span>) <span class="hljs-keyword">continue</span>;<br>                            <span class="hljs-keyword">if</span> (ip.equalsIgnoreCase(<span class="hljs-string">&quot;10.0.2.15&quot;</span>) ||<br>                                    ip.equalsIgnoreCase(<span class="hljs-string">&quot;10.0.2.16&quot;</span>)) &#123;<br>                                choose.add(ip);<br>                            &#125;<br>                        &#125;<br>                    &#125;<br>                &#125;<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>        &#125;<br> <br><span class="hljs-comment">//        try &#123;</span><br><span class="hljs-comment">//            String[] qemuProps = &#123;</span><br><span class="hljs-comment">//                    &quot;ro.kernel.qemu.avd_name&quot;,</span><br><span class="hljs-comment">//                    &quot;ro.kernel.qemu.gles&quot;,</span><br><span class="hljs-comment">//                    &quot;ro.kernel.qemu.gltransport&quot;,</span><br><span class="hljs-comment">//                    &quot;ro.kernel.qemu.opengles.version&quot;,</span><br><span class="hljs-comment">//                    &quot;ro.kernel.qemu.uirenderer&quot;,</span><br><span class="hljs-comment">//                    &quot;ro.kernel.qemu.vsync&quot;,</span><br><span class="hljs-comment">//                    &quot;ro.qemu.initrc&quot;,</span><br><span class="hljs-comment">//                    &quot;init.svc.qemu-props&quot;,</span><br><span class="hljs-comment">//                    &quot;qemu.adb.secure&quot;,</span><br><span class="hljs-comment">//                    &quot;qemu.cmdline&quot;,</span><br><span class="hljs-comment">//                    &quot;qemu.hw.mainkeys&quot;,</span><br><span class="hljs-comment">//                    &quot;qemu.logcat&quot;,</span><br><span class="hljs-comment">//                    &quot;ro.adb.qemud&quot;,</span><br><span class="hljs-comment">//                    &quot;qemu.sf.fake_camera&quot;,</span><br><span class="hljs-comment">//                    &quot;qemu.sf.lcd_density&quot;,</span><br><span class="hljs-comment">//                    &quot;qemu.timezone&quot;,</span><br><span class="hljs-comment">//                    &quot;init.svc.goldfish-logcat&quot;,</span><br><span class="hljs-comment">//                    &quot;ro.boottime.goldfish-logcat&quot;,</span><br><span class="hljs-comment">//                    &quot;ro.hardware.audio.primary&quot;,</span><br><span class="hljs-comment">//                    &quot;init.svc.ranchu-net&quot;,</span><br><span class="hljs-comment">//                    &quot;init.svc.ranchu-setup&quot;,</span><br><span class="hljs-comment">//                    &quot;ro.boottime.ranchu-net&quot;,</span><br><span class="hljs-comment">//                    &quot;ro.boottime.ranchu-setup&quot;,</span><br><span class="hljs-comment">//                    &quot;init.svc.droid4x&quot;,</span><br><span class="hljs-comment">//                    &quot;init.svc.noxd&quot;,</span><br><span class="hljs-comment">//                    &quot;init.svc.qemud&quot;,</span><br><span class="hljs-comment">//                    &quot;init.svc.goldfish-setup&quot;,</span><br><span class="hljs-comment">//                    &quot;init.svc.goldfish-logcat&quot;,</span><br><span class="hljs-comment">//                    &quot;init.svc.ttVM_x86-setup&quot;,</span><br><span class="hljs-comment">//                    &quot;vmos.browser.home&quot;,</span><br><span class="hljs-comment">//                    &quot;vmos.camera.enable&quot;,</span><br><span class="hljs-comment">//                    &quot;ro.trd_yehuo_searchbox&quot;,</span><br><span class="hljs-comment">//                    &quot;init.svc.microvirtd&quot;,</span><br><span class="hljs-comment">//                    &quot;init.svc.vbox86-setup&quot;,</span><br><span class="hljs-comment">//                    &quot;ro.ndk_translation.version&quot;,</span><br><span class="hljs-comment">//                    &quot;redroid.width&quot;,</span><br><span class="hljs-comment">//                    &quot;redroid.height&quot;,</span><br><span class="hljs-comment">//                    &quot;redroid.fps&quot;,</span><br><span class="hljs-comment">//                    &quot;ro.rf.vmname&quot;</span><br><span class="hljs-comment">//            &#125;;</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">//            for (String str : qemuProps) &#123;</span><br><span class="hljs-comment">//                String val = SystemPropertiesUtils.getProperty(str, null);</span><br><span class="hljs-comment">//                if (val != null) &#123;</span><br><span class="hljs-comment">//                    choose.add(str);</span><br><span class="hljs-comment">//                &#125;</span><br><span class="hljs-comment">//            &#125;</span><br><span class="hljs-comment">//        &#125; catch (Throwable e) &#123;</span><br><span class="hljs-comment">//            e.printStackTrace();</span><br><span class="hljs-comment">//        &#125;</span><br>        <span class="hljs-comment">//判断是否存在指定硬件</span><br>        <span class="hljs-type">PackageManager</span> <span class="hljs-variable">pm</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            pm = context.getPackageManager();<br>            String[] features = &#123;<br>                    <span class="hljs-comment">//PackageManager.FEATURE_RAM_NORMAL,//这个存在问题,自己组装的手机可能导致这个痕迹找不到</span><br>                    PackageManager.FEATURE_BLUETOOTH,<br>                    PackageManager.FEATURE_CAMERA_FLASH,<br>                    PackageManager.FEATURE_TELEPHONY<br>            &#125;;<br>            <span class="hljs-keyword">for</span> (String feature : features) &#123;<br>                <span class="hljs-keyword">if</span> (!pm.hasSystemFeature(feature)) &#123;<br>                    choose.add(feature);<br>                &#125;<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (Throwable ignored) &#123;<br>    &#125;<br> <br>    <span class="hljs-keyword">try</span> &#123;<br>        String[] emuPkgs = &#123;<br>                <span class="hljs-string">&quot;com.google.android.launcher.layouts.genymotion&quot;</span>,<br>                <span class="hljs-string">&quot;com.bluestacks&quot;</span>,<br>                <span class="hljs-string">&quot;com.bignox.app&quot;</span><br>        &#125;;<br> <br>        <span class="hljs-keyword">for</span> (String pkg : emuPkgs) &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-keyword">if</span> (pm != <span class="hljs-literal">null</span>) &#123;<br>                    pm.getPackageInfo(pkg, <span class="hljs-number">0</span>);<br>                &#125;<br>                choose.add(pkg);<br>            &#125; <span class="hljs-keyword">catch</span> (Throwable e) &#123;<br>                <span class="hljs-comment">//e.printStackTrace();</span><br>            &#125;<br>        &#125;<br>    &#125; <span class="hljs-keyword">catch</span> (Throwable ignored) &#123;<br> <br>    &#125;<br> <br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-type">SensorManager</span> <span class="hljs-variable">sensor</span> <span class="hljs-operator">=</span> (SensorManager) context.getSystemService(Context.SENSOR_SERVICE);<br>        <span class="hljs-type">int</span> <span class="hljs-variable">sensorSize</span> <span class="hljs-operator">=</span> sensor.getSensorList(Sensor.TYPE_ALL).size();<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; sensorSize; i++) &#123;<br>            <span class="hljs-type">Sensor</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> sensor.getDefaultSensor(i);<br>            <span class="hljs-keyword">if</span> (s != <span class="hljs-literal">null</span> &amp;&amp; s.getName().contains(<span class="hljs-string">&quot;Goldfish&quot;</span>)) &#123;<br>                choose.add(s.getName());<br>            &#125;<br>        &#125;<br>    &#125; <span class="hljs-keyword">catch</span> (Throwable ignored) &#123;<br> <br>    &#125;<br> <br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-keyword">if</span> (checkSelfPermission(context, <span class="hljs-string">&quot;android.permission.READ_SMS&quot;</span>) == <span class="hljs-number">0</span> ||<br>                checkSelfPermission(context, <span class="hljs-string">&quot;android.permission.READ_PHONE_NUMBERS&quot;</span>) == <span class="hljs-number">0</span> ||<br>                    checkSelfPermission(context, <span class="hljs-string">&quot;android.permission.READ_PHONE_STATE&quot;</span>) == <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-type">TelephonyManager</span> <span class="hljs-variable">telephonyManager</span> <span class="hljs-operator">=</span> (TelephonyManager) context.getSystemService(Context.TELEPHONY_SERVICE);<br>            <span class="hljs-type">String</span> <span class="hljs-variable">phoneNumber</span> <span class="hljs-operator">=</span> telephonyManager.getLine1Number();<br> <br>            String[] phoneNumbers = &#123;<br>                    <span class="hljs-string">&quot;15555215554&quot;</span>,<br>                    <span class="hljs-string">&quot;15555215556&quot;</span>,<br>                    <span class="hljs-string">&quot;15555215558&quot;</span>,<br>                    <span class="hljs-string">&quot;15555215560&quot;</span>,<br>                    <span class="hljs-string">&quot;15555215562&quot;</span>,<br>                    <span class="hljs-string">&quot;15555215564&quot;</span>,<br>                    <span class="hljs-string">&quot;15555215566&quot;</span>,<br>                    <span class="hljs-string">&quot;15555215568&quot;</span>,<br>                    <span class="hljs-string">&quot;15555215570&quot;</span>,<br>                    <span class="hljs-string">&quot;15555215572&quot;</span>,<br>                    <span class="hljs-string">&quot;15555215574&quot;</span>,<br>                    <span class="hljs-string">&quot;15555215576&quot;</span>,<br>                    <span class="hljs-string">&quot;15555215578&quot;</span>,<br>                    <span class="hljs-string">&quot;15555215580&quot;</span>,<br>                    <span class="hljs-string">&quot;15555215582&quot;</span>,<br>                    <span class="hljs-string">&quot;15555215584&quot;</span><br>            &#125;;<br>            <span class="hljs-keyword">if</span>(phoneNumber!=<span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-keyword">for</span> (String phone : phoneNumbers) &#123;<br>                    <span class="hljs-keyword">if</span> (phoneNumber.equalsIgnoreCase(phone)) &#123;<br>                        choose.add(phone);<br>                        <span class="hljs-keyword">break</span>;<br>                    &#125;<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>        e.printStackTrace();<br>    &#125;<br> <br>    <span class="hljs-keyword">if</span> (choose.size() &gt; <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-type">ListItemBean</span> <span class="hljs-variable">item</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ListItemBean</span>(<span class="hljs-string">&quot;检测到APK运行在虚拟机&amp;模拟器中&quot;</span>,<br>                ListItemBean.RiskLeave.Deadly,<br>                choose.toString()<br>        );<br>        <span class="hljs-keyword">for</span> (String str : choose) &#123;<br>            item.putData(str);<br>        &#125;<br>        <span class="hljs-keyword">return</span> item;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>检测云手机：<br>这块思路还是很多的，不同的云手机检测的思路也不一样 。大部分云手机做的还是很好的，很多都可以过掉Hunter的检测 。</p>
<p>检测电流&amp;电压：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">BroadcastReceiver</span> <span class="hljs-variable">batteryInfoReceiver</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BroadcastReceiver</span>() &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onReceive</span><span class="hljs-params">(Context context, Intent intent)</span> &#123;<br> <br>        <span class="hljs-comment">// 电池状态</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">plugged</span> <span class="hljs-operator">=</span> intent.getIntExtra(BatteryManager.EXTRA_PLUGGED, -<span class="hljs-number">1</span>);<br> <br>        <span class="hljs-comment">// 电压（以毫伏为单位）</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">voltage</span> <span class="hljs-operator">=</span> intent.getIntExtra(BatteryManager.EXTRA_VOLTAGE, -<span class="hljs-number">1</span>);<br> <br>        <span class="hljs-comment">// 获取电池电流（毫安）</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">currentNow</span> <span class="hljs-operator">=</span> -<span class="hljs-number">1</span>;<br>        <span class="hljs-keyword">if</span> (android.os.Build.VERSION.SDK_INT &gt;= android.os.Build.VERSION_CODES.LOLLIPOP) &#123;<br>            <span class="hljs-type">BatteryManager</span> <span class="hljs-variable">batteryManager</span> <span class="hljs-operator">=</span> (BatteryManager) context.getSystemService(Context.BATTERY_SERVICE);<br>            currentNow = batteryManager.getIntProperty(BatteryManager.BATTERY_PROPERTY_CURRENT_NOW);<br>        &#125;<br> <br>        <span class="hljs-comment">// 判断是否在充电</span><br>        <span class="hljs-keyword">if</span> (plugged == BatteryManager.BATTERY_PLUGGED_AC || plugged == BatteryManager.BATTERY_PLUGGED_USB || plugged == BatteryManager.BATTERY_PLUGGED_WIRELESS) &#123;<br>            <span class="hljs-comment">// 在充电</span><br>            <span class="hljs-keyword">if</span> (voltage != -<span class="hljs-number">1</span> &amp;&amp; currentNow != -<span class="hljs-number">1</span>) &#123;<br>                <span class="hljs-type">float</span> <span class="hljs-variable">voltageInVolts</span> <span class="hljs-operator">=</span> voltage / <span class="hljs-number">1000f</span>; <span class="hljs-comment">// 将电压转换为伏特</span><br>                <span class="hljs-type">float</span> <span class="hljs-variable">currentInAmperes</span> <span class="hljs-operator">=</span> currentNow / <span class="hljs-number">1000000f</span>; <span class="hljs-comment">// 将电流转换为安培</span><br>                <span class="hljs-type">float</span> <span class="hljs-variable">chargingPower</span> <span class="hljs-operator">=</span> voltageInVolts * currentInAmperes; <span class="hljs-comment">// 计算充电功率（瓦特）</span><br>                CLog.i(String.format(<span class="hljs-string">&quot;充电功率: %.2fW&quot;</span>, chargingPower));<br>                <span class="hljs-keyword">if</span> (Math.abs(chargingPower) &gt; <span class="hljs-number">300</span>) &#123;<br>                    CLog.e(<span class="hljs-string">&quot;充电功率过高&quot;</span>);<br>                    handlerItemData(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ListItemBean</span>(<br>                            <span class="hljs-string">&quot;电池异常:充电功率过高(可能是云手机)&quot;</span>,<br>                            ListItemBean.RiskLeave.Deadly,<br>                            <span class="hljs-string">&quot;检测到过大的充电功率 -&gt; &quot;</span> + String.format(<span class="hljs-string">&quot;%.2fW&quot;</span>, Math.abs(chargingPower))<br>                    ));<br>                &#125;<br>            &#125;<br>        &#125;<br> <br>    &#125;<br>&#125;;<br></code></pre></td></tr></table></figure>
<p>检测摄像头&amp;传感器相关：<br>判断摄像头有个数 。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">try</span> &#123;<br>    <span class="hljs-type">CameraManager</span> <span class="hljs-variable">manager</span> <span class="hljs-operator">=</span> (CameraManager) context.getSystemService(Context.CAMERA_SERVICE);<br>    String[] cameraIds = manager.getCameraIdList();<br>    <span class="hljs-comment">//摄像头个数</span><br>    CLog.i(<span class="hljs-string">&quot;cameraIds -&gt; &quot;</span>+ Arrays.toString(cameraIds));<br>    <span class="hljs-keyword">if</span>(cameraIds.length &lt; CAMERA_MINIMUM_QUANTITY_LIMIT)&#123;<br>        items.add(<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ListItemBean</span>(<br>                <span class="hljs-string">&quot;当前手机可能是模拟器&amp;云手机&quot;</span>,<br>                ListItemBean.RiskLeave.Warn,<br>                <span class="hljs-string">&quot;camera size -&gt; &quot;</span>+cameraIds.length<br>        ));<br>    &#125;<br>&#125; <span class="hljs-keyword">catch</span> (Throwable ignored) &#123;<br> <br>&#125;<br></code></pre></td></tr></table></figure>
<p>检测传感器个数：<br>这块思路就是直接获取个数，少于10个可以直接认定为黑产 。 我目前没发现那个手机少于10个传感器 ，这块如果可能的话可以尝试调用一下传感器，保证传感器是否可用 ，防止云手机以假乱真 。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">try</span> &#123;<br>    <span class="hljs-comment">//3,检测传感器类型,支持的全部类型传感器</span><br>    <span class="hljs-type">SensorManager</span> <span class="hljs-variable">sm</span> <span class="hljs-operator">=</span> (SensorManager) context.getSystemService(SENSOR_SERVICE);<br>    List&lt;Sensor&gt; sensorlist = sm.getSensorList(Sensor.TYPE_ALL);<br> <br>    ArrayList&lt;Integer&gt; sensorTypeS = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>    <span class="hljs-keyword">for</span> (Sensor sensor : sensorlist) &#123;<br>        <span class="hljs-comment">//获取传感器类型</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">type</span> <span class="hljs-operator">=</span> sensor.getType();<br>        <span class="hljs-keyword">if</span> (!sensorTypeS.contains(type)) &#123;<br>            <span class="hljs-comment">//发现一种类型则添加一种类型</span><br>            sensorTypeS.add(type);<br>        &#125;<br>    &#125;<br>    <span class="hljs-comment">//小米k40 51个传感器类型</span><br>    <span class="hljs-comment">//普通的pix 27个</span><br>    <span class="hljs-comment">//华为荣耀20 18个传感器</span><br>    CLog.e(<span class="hljs-string">&quot;sensor types size -&gt; &quot;</span> + sensorlist.size());<br>    <span class="hljs-comment">//我们认为传感器少于20个则认为是风险设备</span><br>    <span class="hljs-keyword">if</span> (sensorlist.size() &lt; SENSOR_MINIMUM_QUANTITY_LIMIT) &#123;<br>        items.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ListItemBean</span>(<br>                <span class="hljs-string">&quot;当前手机可能是模拟器&amp;云手机&quot;</span>,<br>                ListItemBean.RiskLeave.Warn,<br>                <span class="hljs-string">&quot;sensor size -&gt; (&quot;</span>+ sensorlist.size()+<span class="hljs-string">&quot;) \n&quot;</span> +<br>                <span class="hljs-string">&quot;sensor type size -&gt; (&quot;</span>+sensorTypeS.size()+<span class="hljs-string">&quot;) \n&quot;</span><br>                <span class="hljs-comment">//+ &quot;sensor info -&gt; \n&quot;+ Sensorlist   //打印全部传感器信息</span><br>        ));<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>检测传感器名称：<br>这块检测思路主要是检测传感器的名称，正常小米之类的手机他是不可能存在叫什么 AOSP的传感器的 。</p>
<p>这种AOSP基本都是自己编译的ROM ，所以这块也可以作为监测点 。可以上报传感器的一些名称信息，也是环境检测一个很重要的抓手 。</p>
<p>一般小白肯定不会说去改传感器名称 。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.N) &#123;<br>    ArrayList&lt;Sensor&gt; aospSensor = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>    <span class="hljs-keyword">for</span>(Sensor sensor:sensorlist)&#123;<br>        <span class="hljs-keyword">if</span>(sensor.getVendor().contains(<span class="hljs-string">&quot;AOSP&quot;</span>))&#123;<br>            aospSensor.add(sensor);<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (aospSensor.size()&gt;<span class="hljs-number">3</span>) &#123;<br>        CLog.e(<span class="hljs-string">&quot;传感器参数是否异常(生产厂商为AOSP)&quot;</span>);<br>        items.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ListItemBean</span>(<br>                <span class="hljs-string">&quot;当前手机可能是模拟器&amp;云手机&quot;</span>,<br>                ListItemBean.RiskLeave.Warn,<br>                aospSensor.size()<br>                        +<span class="hljs-string">&quot;/&quot;</span>+sensorlist.size()+<span class="hljs-string">&quot;传感器参数异常 -&gt; &quot;</span>+ aospSensor<br>        ));<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>检测挂载文件：<br>这块就是去遍历mounts 下面这几个文件，检测里面是否包含docker关键字 ，防止一些云手机搞虚拟化，通过使用docker进行挂载 。</p>
<p>这块也是很好的监测点 。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java">String[] marks = &#123;<span class="hljs-string">&quot;docker&quot;</span>&#125;;<br><span class="hljs-comment">//检测proc/mounts是否包含docker关键字</span><br><span class="hljs-type">String</span> <span class="hljs-variable">mark</span> <span class="hljs-operator">=</span> NativeEngine.getZhenxiInfoK(<span class="hljs-string">&quot;/proc/mounts&quot;</span>,marks );<br><span class="hljs-keyword">if</span>(mark == <span class="hljs-literal">null</span>)&#123;<br>    mark = NativeEngine.getZhenxiInfoK(<span class="hljs-string">&quot;/proc/self/mountstats&quot;</span>, marks);<br>    <span class="hljs-keyword">if</span>(mark == <span class="hljs-literal">null</span>)&#123;<br>        mark = NativeEngine.getZhenxiInfoK(<span class="hljs-string">&quot;/proc/self/mountinfo&quot;</span>, marks);<br>    &#125;<br>&#125;<br><span class="hljs-keyword">if</span>(mark!=<span class="hljs-literal">null</span>)&#123;<br>    items.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ListItemBean</span>(<br>            <span class="hljs-string">&quot;当前手机可能是模拟器&amp;云手机&quot;</span>,<br>            ListItemBean.RiskLeave.Warn,<br>            <span class="hljs-string">&quot;(mounts异常)\n&quot;</span>+mark<br>    ));<br>&#125;<br></code></pre></td></tr></table></figure>
<p>检测ROM是否Match:<br>检测环境信息：<br>这块思路主要好多种 ，主要是为了防止一些自定义ROM ，通过修改机型的方法，绕过自定义ROM检测逃逸 。</p>
<p>可以直接执行getprop 把所有的环境信息都拿到手 ，如果是小米手机，里面环境信息里面，肯定是有MIUI关键字。</p>
<p>比如小米的手机，我会去检测是否包含这几个关键环境信息 。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">KEY_MIUI_VERSION_NAME</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;ro.miui.ui.version.name&quot;</span>;<br><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">KEY_MIUI_VERSION_CODE</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;ro.miui.ui.version.code&quot;</span>;<br><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">KEY_MIUI_INTERNAL_STORAGE</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;ro.miui.internal.storage&quot;</span>;<br></code></pre></td></tr></table></figure>
<p>这块可以采集以后服务端进行判断 。防止自定义ROM 机型伪造 。</p>
<p>检测服务列表：<br>这块还是执行 service list ，一般小米手机之类的，都会有小米的系统服务，这种东西很难去伪造，如果他伪造了假的 。你就尝试调用即可 。</p>
<p>这块还是建议上传到服务端，由服务端算法同学去根据相似度算法去推断 ，不要再本地进行判断 ，因为Hunter是非联网Apk，所以只是在客户端打了个样子 。</p>
<p>检测当前环境是否被Hook:<br>这块检测方法千奇百怪，首先最基本maps去检测frida或者根据调用栈检测lsp特征 ，基础的检测方案不说了 。因为我觉得并不是一个很好的方案 。改个名就绕过了 。</p>
<p>比如frida特征三件套 。检测思路主要</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-type">char</span> *FRIDA_THREAD_GUM_JS_LOOP = <span class="hljs-string">&quot;gum-js-loop&quot;</span>;<br><span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-type">char</span> *FRIDA_THREAD_GMAIN = <span class="hljs-string">&quot;gmain&quot;</span>;<br><span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-type">char</span> *FRIDA_NAMEDPIPE_LINJECTOR = <span class="hljs-string">&quot;linjector&quot;</span>;<br></code></pre></td></tr></table></figure>
<p>Hook检测，我们其实只需要检测内存没有被修改即可 。这块需要介绍一下基础原理。和实现的伪代码 。</p>
<p>正常我们知道一个SO加载到内存里，本质上是通过mmap把so分配到内存里面 ，比如A函数的指令是BBB，那么加载到内存里面应该也是BBB 。</p>
<p>记住上面这句话 ，我们就可以对内存里面的指令转换成一个int值，然后累加 。如果内存没有被修改 ，累加值文件里面和内存里面的值应该是一样的 。</p>
<p>因为现在Hook基本都是text段和plt端，一个inlinehook一个got表 。当然Frida可能会延迟启动 ，所以开启一条检测线程，进行轮训操作。</p>
<p>这块还有一个设计问题，很多开发者也都没注意到 ，就是我开启的这一条线程，被攻击者anti掉 应该怎么办呢？</p>
<p>因为想要anti掉一条检测线程，方法太多了，N种方法，比如监听全部线程的文件读写，看看那个线程在读取文件 ，只做这一件事，基本八九不离十 ，</p>
<p>也可以直接Hook开启线程的方法，对开启的线程进行anti 。当然这种思路 就没有好的对抗或者检测办法了么？</p>
<p>其实很简单 ，只需要把在你的检测代码里，对某个变量进行赋值 ，修改flag即可 。</p>
<p>然后第一次检测完毕以后将主进程的某个变量标志为true，可以使用__NR_process_vm_writev ，又因为是异步的关系，主线程可以延迟2秒对这个标识进行获取，判断是否为true ，</p>
<p>以确保检测线程成功开启 。</p>
<p>具体检测流程如下，以检测libc为例子，路径可以换成自己需要的路径 ：</p>
<p>首先获取本地So文件的累加值 ，返回execSection 结构体 。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">//记录可执行段的结构体,一个是plt段一个是text段</span><br><span class="hljs-comment">//所以对应的数量是2</span><br><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">stExecSection</span> &#123;<br>    <span class="hljs-type">int</span> execSectionCount;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> offset[<span class="hljs-number">2</span>];<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> memsize[<span class="hljs-number">2</span>];<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> checksum[<span class="hljs-number">2</span>];<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> startAddrinMem;<br>    <span class="hljs-type">bool</span> isSuccess = <span class="hljs-literal">false</span>;<br>&#125; execSection;<br><br> <br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 获取本地文件的 Check sum</span><br><span class="hljs-comment"> * 读取耗时操作,只初始化一次保存到本地。</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function">execSection <span class="hljs-title">fetch_checksum_of_library</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *filePath)</span> </span>&#123;<br>    execSection section = &#123;<span class="hljs-number">0</span>&#125;;<br>    Elf_Ehdr ehdr;<br>    Elf_Shdr sectHdr;<br>    <span class="hljs-type">int</span> fd;<br>    <span class="hljs-type">int</span> execSectionCount = <span class="hljs-number">0</span>;<br>    fd = <span class="hljs-built_in">my_openat</span>(AT_FDCWD, filePath, O_RDONLY, <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">if</span> (fd &lt; <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-keyword">return</span> section;<br>    &#125;<br> <br>    <span class="hljs-built_in">my_read</span>(fd, &amp;ehdr, <span class="hljs-built_in">sizeof</span>(Elf_Ehdr));<br>    <span class="hljs-built_in">my_lseek</span>(fd, (<span class="hljs-type">off_t</span>) ehdr.e_shoff, SEEK_SET);<br> <br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> memSize[<span class="hljs-number">2</span>] = &#123;<span class="hljs-number">0</span>&#125;;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> offset[<span class="hljs-number">2</span>] = &#123;<span class="hljs-number">0</span>&#125;;<br> <br>    <span class="hljs-comment">//查找section的plt和text开始位置和长度</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; ehdr.e_shnum; i++) &#123;<br>        <span class="hljs-built_in">my_memset</span>(&amp;sectHdr, <span class="hljs-number">0</span>, <span class="hljs-built_in">sizeof</span>(Elf_Shdr));<br>        <span class="hljs-built_in">my_read</span>(fd, &amp;sectHdr, <span class="hljs-built_in">sizeof</span>(Elf_Shdr));<br>        <span class="hljs-comment">//通常 PLT and Text 一般都是可执行段</span><br>        <span class="hljs-keyword">if</span> (sectHdr.sh_flags &amp; SHF_EXECINSTR) &#123;<br>            offset[execSectionCount] = sectHdr.sh_offset;<br>            memSize[execSectionCount] = sectHdr.sh_size;<br>            execSectionCount++;<br>            <span class="hljs-keyword">if</span> (execSectionCount == <span class="hljs-number">2</span>) &#123;<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (execSectionCount == <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-built_in">LOG</span>(INFO) &lt;&lt; <span class="hljs-string">&quot;get elf section error &quot;</span> &lt;&lt; filePath;<br>        <span class="hljs-built_in">my_close</span>(fd);<br>        <span class="hljs-keyword">return</span> section;<br>    &#125;<br> <br>    <span class="hljs-comment">//记录个数</span><br>    section.execSectionCount = execSectionCount;<br> <br>    section.startAddrinMem = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; execSectionCount; i++) &#123;<br>        <span class="hljs-built_in">my_lseek</span>(fd, (<span class="hljs-type">off_t</span>) offset[i], SEEK_SET);<br>        <span class="hljs-comment">//void * buffer = alloca(memSize[i] * sizeof(uint8_t));</span><br>        <span class="hljs-comment">//存放text或者plt全部的数据内容,大约5-10M大小,为了兼容小内存手机。</span><br>        <span class="hljs-comment">//所以放在堆里面,而不是栈,防止小内存手机栈指针溢出。</span><br>        <span class="hljs-keyword">auto</span> buffer = (<span class="hljs-type">void</span> *) <span class="hljs-built_in">calloc</span>(<span class="hljs-number">1</span>, memSize[i] * <span class="hljs-built_in">sizeof</span>(<span class="hljs-type">uint8_t</span>));<br>        <span class="hljs-keyword">if</span> (buffer == <span class="hljs-literal">nullptr</span>) &#123;<br>            <span class="hljs-built_in">free</span>(buffer);<br>            <span class="hljs-keyword">return</span> section;<br>        &#125;<br>        <span class="hljs-built_in">my_read</span>(fd, buffer, memSize[i]);<br>        section.offset[i] = offset[i];<br>        section.memsize[i] = memSize[i];<br>        section.checksum[i] = <span class="hljs-built_in">checksum</span>(buffer, memSize[i]);<br> <br><span class="hljs-comment">//        LOGE(&quot;fetch_checksum_of_library %s ExecSection:[%d][%ld][%ld][%ld]&quot;,</span><br><span class="hljs-comment">//             filePath, i, offset[i], memSize[i], section-&gt;checksum[i])</span><br>        <span class="hljs-built_in">free</span>(buffer);<br>    &#125;<br>    section.isSuccess = <span class="hljs-literal">true</span>;<br>    <span class="hljs-built_in">my_close</span>(fd);<br>    <span class="hljs-keyword">return</span> section;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>然后和本地的指令去计算 。计算本地的指令方法就是对maps进行遍历，只遍历text和plt段 ，计算累加值和本地进行判断 。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 检测问的check sum</span><br><span class="hljs-comment"> * 检测到check未修改返回0</span><br><span class="hljs-comment"> * 检测已修改返回1</span><br><span class="hljs-comment"> * 检测失败返回-1</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">detect_elf_checksum</span><span class="hljs-params">(const <span class="hljs-type">char</span> *soPath, execSection *pSection)</span> &#123;<br>    <span class="hljs-keyword">if</span> (pSection == nullptr) &#123;<br>        LOGI(<span class="hljs-string">&quot;detect_elf_checksum execSection == null  &quot;</span>);<br>        <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;<br>    &#125;<br> <br>    <span class="hljs-type">char</span> map[MAX_LINE];<br>    const <span class="hljs-type">char</span> *maps_path = string(<span class="hljs-string">&quot;proc/&quot;</span>).append(to_string(getpid())).append(<span class="hljs-string">&quot;/maps&quot;</span>).c_str();<br> <br>    <span class="hljs-type">int</span> <span class="hljs-variable">fd</span> <span class="hljs-operator">=</span> my_openat(AT_FDCWD, maps_path, O_RDONLY, <span class="hljs-number">0</span>);<br> <br>    <span class="hljs-keyword">if</span> (fd &lt;= <span class="hljs-number">0</span>) &#123;<br>        LOGE(<span class="hljs-string">&quot;detect_elf_checksum open %s fail &quot;</span>, PROC_MAPS);<br>        <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;<br>    &#125;<br>    <span class="hljs-type">int</span> <span class="hljs-variable">checkSum</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">while</span> ((read_one_line(fd, map, MAX_LINE)) &gt; <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-keyword">if</span> (my_strstr(map, soPath) != nullptr) &#123;<br>            checkSum = scan_executable_segments(map, pSection, soPath);<br>            <span class="hljs-keyword">if</span> (checkSum == <span class="hljs-number">1</span>) &#123;<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>        &#125;<br>    &#125;<br> <br>    my_close(fd);<br>    <span class="hljs-keyword">return</span> checkSum;<br>&#125;<br> <br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 检测问的check sum</span><br><span class="hljs-comment"> * 检测到check未修改返回0</span><br><span class="hljs-comment"> * 检测已修改返回1</span><br><span class="hljs-comment"> * 检测失败返回-1</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">scan_executable_segments</span><span class="hljs-params">(</span><br><span class="hljs-params">        <span class="hljs-type">char</span> *mapItem,</span><br><span class="hljs-params">        execSection *pElfSectArr,</span><br><span class="hljs-params">        const <span class="hljs-type">char</span> *libraryName)</span> &#123;<br>    unsigned <span class="hljs-type">long</span> start, end;<br>    <span class="hljs-type">char</span> buf[MAX_LINE] = <span class="hljs-string">&quot;&quot;</span>;<br>    <span class="hljs-type">char</span> path[MAX_LENGTH] = <span class="hljs-string">&quot;&quot;</span>;<br>    <span class="hljs-type">char</span> tmp[<span class="hljs-number">100</span>] = <span class="hljs-string">&quot;&quot;</span>;<br> <br>    sscanf(mapItem, <span class="hljs-string">&quot;%lx-%lx %s %s %s %s %s&quot;</span>, &amp;start, &amp;end, buf, tmp, tmp, tmp, path);<br> <br>    <span class="hljs-keyword">if</span> (buf[<span class="hljs-number">2</span>] == <span class="hljs-string">&#x27;x&#x27;</span>) &#123;<br>        <span class="hljs-keyword">if</span> (buf[<span class="hljs-number">0</span>] == <span class="hljs-string">&#x27;r&#x27;</span>) &#123;<br>            uint8_t *buffer;<br> <br>            buffer = (uint8_t *) start;<br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; pElfSectArr-&gt;execSectionCount; i++) &#123;<br>                <span class="hljs-keyword">if</span> (start + pElfSectArr-&gt;offset[i] + pElfSectArr-&gt;memsize[i] &gt; end) &#123;<br>                    <span class="hljs-keyword">if</span> (pElfSectArr-&gt;startAddrinMem != <span class="hljs-number">0</span>) &#123;<br>                        buffer = (uint8_t *) pElfSectArr-&gt;startAddrinMem;<br>                        pElfSectArr-&gt;startAddrinMem = <span class="hljs-number">0</span>;<br>                        <span class="hljs-keyword">break</span>;<br>                    &#125;<br>                &#125;<br>            &#125;<br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; pElfSectArr-&gt;execSectionCount; i++) &#123;<br>                <span class="hljs-type">auto</span> <span class="hljs-variable">begin</span> <span class="hljs-operator">=</span> (<span class="hljs-keyword">void</span> *) (buffer + pElfSectArr-&gt;offset[i]);<br>                unsigned <span class="hljs-type">long</span> <span class="hljs-variable">size</span> <span class="hljs-operator">=</span> pElfSectArr-&gt;memsize[i];<br>                LOGI(<span class="hljs-string">&quot;%s [%p] size -&gt;[%lu]&quot;</span>, libraryName, begin, size);<br>                <span class="hljs-comment">//MPROTECT((size_t)begin, size, MEMORY_R);</span><br>                unsigned <span class="hljs-type">long</span> <span class="hljs-variable">output</span> <span class="hljs-operator">=</span> checksum(begin, size);<br>                LOGI(<span class="hljs-string">&quot;%s checksum:[%ld][%ld]&quot;</span>, libraryName, output, pElfSectArr-&gt;checksum[i])<br>                <span class="hljs-keyword">if</span> (output != pElfSectArr-&gt;checksum[i]) &#123;<br>                    <span class="hljs-comment">//和本地的So Checksum 对不上</span><br>                    <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>                &#125;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">if</span> (buf[<span class="hljs-number">0</span>] == <span class="hljs-string">&#x27;r&#x27;</span>) &#123;<br>            pElfSectArr-&gt;startAddrinMem = start;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>当然这块就一定是比较完善的检测方案了么？其实有很多对抗思路 。比如把maps里面的内存进行隐藏，变成匿名内存，这样他在扫描maps的就找不到，对应的比如上面说的libc的item ，</p>
<p>这块可以参考riru里面的 map_hide ，代码路径如下 ：</p>
<p><a target="_blank" rel="noopener" href="https://github.com/RikkaApps/Riru/blob/master/riru/src/main/cpp/hide_utils.cpp">https://github.com/RikkaApps/Riru/blob/master/riru/src/main/cpp/hide_utils.cpp</a></p>
<p>当然这种方式一定是安全的么？</p>
<p>其实，不是的，因为在他的这个代码里面我发现存在一个遗漏点，可以作为检测入手点 ，某个加固厂商，不仅仅会对maps item进行遍历 ，还会对里面的匿名内存进行遍历 ，检测匿名内存里面的 magic ，比如so 文件的magic是elf ，如果magic 匹配上一样当maps去解析 去遍历。</p>
<p>所以可以在原有的基础上改改，在将内存变成匿名内存以后，把elf的前四个字节抹掉，也就是magic的 内容，抹掉以后记得把权限修改成和之前的一样 。防止内存检测 。</p>
<p>检测沙箱：<br>这块检测核心逻辑全部放在ISO线程检测 。可以配置一个服务，然后服务里使用如下变量即可 。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">&lt;service<br>    android:name=&quot;.ZhenxiServer&quot;<br>    android:isolatedProcess=&quot;true&quot;<br>    android:useAppZygote=&quot;true&quot;<br>    /&gt;<br>```    <br>这个服务非常恶心，一般沙箱对这个线程都会进行跳过 。<br><br> <br>这块有人可能会问什么是iso线程？可以理解成一个独立的安全的线程，只能通过和外部IPC交互的方式进行通讯 。useAppZygote 相当于让这个进程运行在Zygote中 。这个时候时机特别早，早到什么程度呢？就连libart.so 都没加载，所以这个检测进程只能调用一些原始的libc方法，不能调用任何Art相关的函数 。<br><br> <br>再多的我也不知道了 ，这块具体什么是ISO线程，让GTP回答一下吧，回答如下 ：<br></code></pre></td></tr></table></figure>
<p>我:<br>请你分别介绍一下这两个标签的详细含义 .<br>android:isolatedProcess&#x3D;”true”<br>android:useAppZygote&#x3D;”true”<br>以及他们的使用场景 ?</p>
<p>ChatGPT:<br>这两个属性都属于Android清单文件（Android Manifest）中<service>标签的属性。它们控制你的应用服务（Service）如何运行。</service></p>
<p>android:isolatedProcess&#x3D;”true”：</p>
<p>android:isolatedProcess属性控制服务是否在一个特殊的孤立进程（isolated process）中运行。如果此属性设置为 “true”，那么服务将运行在一个没有任何权限的孤立进程中。这个进程是应用的一个私有进程，其不与应用的其他部分共享同一Linux用户ID和权限。由于孤立进程不具备任何权限，因此它无法访问设备的大部分资源，除非通过IPC机制向其他进程请求。这种方式可以提高安全性，因为即使孤立进程被攻破，攻击者也无法直接访问应用的其他资源。一般来说，如果你的服务需要处理敏感数据或执行敏感操作，可以考虑使用孤立进程。</p>
<p>android:useAppZygote&#x3D;”true”：</p>
<p>android:useAppZygote这个属性指定了应用的服务是否应该在一个专用的AppZygote进程中运行。AppZygote进程是一个预加载了应用共享资源和一些类的轻量级进程，可以更快地启动服务。如果此属性设置为”true”，那么服务将在一个AppZygote进程中运行。这种方式可以提高服务启动速度，但可能会导致内存消耗增加。一般来说，如果你的服务需要频繁启动，而且启动速度很关键，你可以考虑使用AppZygote进程。</p>
<p>请注意，这两个属性的具体行为可能取决于Android的版本和设备制造商的实现，你可能需要在实际设备上进行测试以确认它们的行为。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">下面也是主要介绍一下hunter的检测思路 。<br><br>检测多余线程PID:<br>主要实现思路就是去检测proc下面是否有除了main进程以外的其他pid ,因为正常启动的话，肯定是只有一个main进程 。<br><br> <br>但是沙箱的话会在启动之前去启动别的进程 ，所以这块可以进行bypass 。后面我会统一说这块应该如何对抗 ，包括如何绕过 。<br><br> <br>这块先介绍检测思路 ，和检测原理 。这块里面有一个replaceSecInsns是我自己封装的一个函数，我担心 opendir 被Hook了，所以每次执行都去把指令替换成<br><br> <br>本地文件的指令，而不是去执行内存里面的指令 。<br><br>``` c++<br>auto orig_opendir = reinterpret_cast&lt;DIR *(*)<br>            (const char *)&gt;(replaceSecInsns(getlibcPath(), &quot;opendir&quot;));<br>    DIR *pdr = orig_opendir(&quot;/proc&quot;);<br>    if (pdr == nullptr) &#123;<br>        return getItemData(env, &quot;程序出错请放弃修改后重试&quot;,<br>                           nullptr, true, RISK_LEAVE_DEADLY, TAG_SANDBOX);<br>    &#125;<br>    auto orig_ator = reinterpret_cast&lt;struct dirent *(*)(DIR *)&gt;<br>    (replaceSecInsns(getlibcPath(), &quot;readdir&quot;));<br>    dirent *read_ptr;<br>    //在app启动之前检测当前app所有的进程,判断是否存在和main不一样的进程<br>    while ((read_ptr = orig_ator(pdr)) != nullptr) &#123;<br>        long procPid = strtol(read_ptr-&gt;d_name, nullptr, 10);<br>        //LOG(INFO) &lt;&lt; &quot;find /proc/ child dir  &quot; &lt;&lt; procPid;<br>        //打开成功&amp;&amp;发现一条不等于主进程id的pid<br>        if (procPid &amp;&amp; procPid != getpid()) &#123;<br>            auto title = string(&quot;检测到APK存在沙箱内部&quot;);<br>            char buff[200];<br>            getNameByPid((pid_t) procPid, buff);<br>            LOG(ERROR) &lt;&lt; &quot;&gt;&gt;&gt;&gt;&gt;  FIND OTHER THREAD SANDBOX &quot; &lt;&lt; procPid &lt;&lt; &quot;  &quot; &lt;&lt; buff;<br>            auto &amp;data =<br>                    string(&quot;当前线程主进程PID(&quot;).append(to_string(getpid())).append(&quot;)&quot;).append(&quot;\n&quot;).<br>                            append(&quot;异常pid -&gt; &quot;).append(to_string(procPid)).<br>                            append(&quot;(&quot;).append(&quot;pid name: &quot;).append(buff).append(&quot;)&quot;);<br>            //可能存在多个异常pid而非一个<br>            getItemData(env, title, data.c_str(), false, RISK_LEAVE_WARN, TAG_SANDBOX);<br>        &#125;<br>    &#125;<br>    closedir(pdr);<br>```    <br>对抗：<br>这块想要绕过也很简单，opendir 底层其实就是 getdents64，getdents 如果遇到你想隐藏的文件直接对文件进行bypass就可以了，直接指向下一个指针 ，<br><br> <br>代码来自proot<br>``` c++<br>        case SC_getdents64:<br>        case SC_getdents: &#123;<br>            /* get the result of the syscall, which is the number of bytes read by getdents<br>             * 获取系统调用的结果，即getdents读取的字节数<br>             * */<br>            unsigned int res = peek_reg(tracee, CURRENT, SYSARG_RESULT);<br>            if (res &lt;= 0) &#123;<br>                break;<br>            &#125;<br> <br>            /* get the system call arguments */<br>            word_t orig_start = peek_reg(tracee, CURRENT, SYSARG_2);<br>            unsigned int count = peek_reg(tracee, CURRENT, SYSARG_3);<br>            char orig[count];<br> <br>            char path[PATH_MAX];<br>            int status = readlink_proc_pid_fd(tracee-&gt;pid,<br>                                              (int) peek_reg(tracee, ORIGINAL, SYSARG_1), path);<br>            if (status &lt; 0) &#123;<br>                break;<br>            &#125;<br>            //不属于绑定路径则不处理,这块应该加个判断。如果这个path没有处理的路径应该返回 。<br>            //目前需要处理的只有proc,用于隐藏调试线程。<br>//            if(!belongs_to_guestfs(tracee, path))<br>//                return 0;<br>            if (!StringUtils::containsInsensitive(path,&quot;proc&quot;))&#123;<br>                break;<br>            &#125;<br>            /* retrieve the data from getdents<br>             * 从getdents检索数据<br>             * */<br>            status = read_data(tracee, orig, orig_start, res);<br>            if (status &lt; 0) &#123;<br>                break;<br>            &#125;<br> <br>            /* allocate a space for the copy of the data we want<br>             * 为我们想要的数据的副本分配一个空间<br>             * */<br>            char copy[count];<br>            /* curr will hold the current struct we&#x27;re examining<br>             * curr将保存我们正在检查的当前结构<br>             * */<br>            struct linux_dirent64 *curr64;<br>            struct linux_dirent *curr32;<br>            /* pos keeps track of where in memory the copy is<br>             * pos跟踪副本在内存中的位置<br>             * */<br>            char *pos = copy;<br>            /* ptr keeps track of where in memory the original is<br>             * ptr跟踪原始文件在内存中的位置<br>             * */<br>            char *ptr = orig;<br>            /* nleft keeps track of how many bytes we&#x27;ve saved<br>             * nleft跟踪我们保存了多少字节<br>             * */<br>            unsigned int nleft = 0;<br> <br>            /* while we&#x27;re still within the memory allowed<br>             * 当我们还在允许的memory范围内时<br>             * */<br>            if (get_sysnum(tracee, ORIGINAL) == SC_getdents64) &#123;<br>                while (ptr &lt; orig + res) &#123;<br> <br>                    /* get the current struct<br>                     * 获取当前结构<br>                     * */<br>                    curr64 = (struct linux_dirent64 *) ptr;<br> <br>                    /* if the name does not matche a given prefix<br>                     * 如果名称与给定前缀不匹配<br>                     *<br>                     * 如果这个目录项的名称不以HIDDEN_PREFIX开始，<br>                     * 也就是hasprefix(HIDDEN_PREFIX, curr64-&gt;d_name)返回false，<br>                     * 那么这个目录项会被保留在结果中，否则，这个目录项会被忽略，也就是隐藏。<br>                     * */<br>                    //if (!hasprefix(HIDDEN_PREFIX, curr64-&gt;d_name)) &#123;<br>                    if (!isRuntimeHideDir(tracee-&gt;pid,curr64-&gt;d_name, tracer_pc(tracee), tracer_lr(tracee))) &#123;<br>                        /* copy the information<br>                         * 复制信息<br>                         * */<br>                        mybcopy(ptr, pos, curr64-&gt;d_reclen);<br> <br>                        /* move the pos and nleft */<br>                        pos += curr64-&gt;d_reclen;<br>                        nleft += curr64-&gt;d_reclen;<br>                    &#125;<br>                    /* move to the next linux_dirent<br>                     * 隐藏这个目录,指向下一个文件<br>                     * */<br>                    ptr += curr64-&gt;d_reclen;<br>                &#125;<br>            &#125; else &#123;<br>                while (ptr &lt; orig + res) &#123;<br> <br>                    /* get the current struct */<br>                    curr32 = (struct linux_dirent *) ptr;<br> <br>                    /* if the name does not matche a given prefix */<br>//                    if (!hasprefix(HIDDEN_PREFIX, curr64-&gt;d_name)) &#123;<br>                    if (!isRuntimeHideDir(tracee-&gt;pid,curr32-&gt;d_name, tracer_pc(tracee), tracer_lr(tracee))) &#123;<br> <br>                        /* copy the information */<br>                        mybcopy(ptr, pos, curr32-&gt;d_reclen);<br> <br>                        /* move the pos and nleft */<br>                        pos += curr32-&gt;d_reclen;<br>                        nleft += curr32-&gt;d_reclen;<br>                    &#125;<br>                    /* move to the next linux_dirent */<br>                    ptr += curr32-&gt;d_reclen;<br>                &#125;<br>            &#125;<br>            /* If there is nothing left<br>             * 这个文件夹里面本身没有东西,暂不处理<br>             * */<br>            if (!nleft) &#123;<br>//                /* call getdents again */<br>//                if (get_sysnum(tracee, ORIGINAL) == PR_getdents64)<br>//                    register_chained_syscall(tracee, PR_getdents64, peek_reg(tracee, ORIGINAL, SYSARG_1), orig_start, count, 0, 0, 0);<br>//                else<br>//                    register_chained_syscall(tracee, PR_getdents, peek_reg(tracee, ORIGINAL, SYSARG_1), orig_start, count, 0, 0, 0);<br>            &#125; else &#123;<br>                /* copy the data back into the register */<br>                status = write_data(tracee, orig_start, copy, nleft);<br>                if (status &lt; 0) &#123;<br>                    break;<br>                &#125;<br>                /* update the return value to match the data */<br>                poke_reg(tracee, SYSARG_RESULT, nleft);<br>            &#125;<br>            break;<br>        &#125;<br>```        <br>执行ps命令：<br>这块的思路就是检测是否存在其他进程 ，通过执行ps -ef命令 。<br><br>``` c++<br>if (get_sdk_level() &gt; ANDROID_Q) &#123;<br>    //check process<br>    auto orig_popen = reinterpret_cast&lt;FILE *(*)(const char *,<br>                                                 const char *)&gt;(replaceSecInsns(getlibcPath(),<br>                                                                                &quot;popen&quot;));<br>    FILE *file = orig_popen(&quot;ps -ef&quot;, &quot;r&quot;);<br>    if (file == nullptr) &#123;<br>        return getItemData(env, &quot;程序出错请放弃修改后重试&quot;,<br>                           &quot;ps error&quot;, true, 3, TAG_SANDBOX);<br>    &#125;<br>    char buf[0x1000];<br>    string buffStr;<br>    uint size = 0;<br>    // get process count size<br>    while (fgets(buf, sizeof(buf), file)) &#123;<br>        buffStr.append(buf).append(&quot;\n&quot;);<br>        //不包含++<br>        if(!StringUtils::contains(buf,&quot;hunter&quot;))&#123;<br>            size++;<br>            LOG(INFO) &lt;&lt; &quot;ps -ef match -&gt; %s &quot; &lt;&lt; buf;<br>        &#125;<br>    &#125;<br>    if (size &gt; 2) &#123;<br>        //UID             PID   PPID C STIME TTY          TIME CMD<br>        //u0_a531        6187    885 72 10:27:53 ?    00:00:00 com.zhenxi.hunter<br>        //u0_a531        6236   6187 0 10:27:53 ?     00:00:00 ps -ef<br>        pclose(file);<br> <br>        return getItemData(env, &quot;检测到APK存在沙箱内部(异常线程)&quot;,<br>                           buffStr.c_str(), false, RISK_LEAVE_DEADLY, TAG_SANDBOX);<br>    &#125;<br>    LOG(ERROR) &lt;&lt; &quot;&gt;&gt;&gt;&gt;&gt; NOT FIND SANDBOX &quot;;<br>    pclose(file);<br>&#125;<br></code></pre></td></tr></table></figure>
<p>对抗：<br>可以先伪造一个正常的文件，在执行到 ps -ef的时候把命令换成cat 你自己的文件 即可 。</p>
<p>内存Choose:<br>这块的实现思路就是，检测内存里面的 Activity 或者 Application的个数 。正常我们的apk启动只会有我们自己的</p>
<p>Application，沙箱因为预启动的关系，会存在其他的Application ，这块也是一个很好的检测思路 。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ListItemBean <span class="hljs-title function_">checkSandbox</span><span class="hljs-params">()</span> &#123;<br>    ArrayList&lt;Object&gt; choose;<br>    <span class="hljs-keyword">try</span> &#123;<br>        choose = ChooseUtils.choose(Activity.class, <span class="hljs-literal">true</span>);<br>    &#125; <span class="hljs-keyword">catch</span> (Throwable e) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (choose != <span class="hljs-literal">null</span>) &#123;<br>        ArrayList&lt;Object&gt; list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        <span class="hljs-comment">//移除我们的Activity,把其他的activity实例加到List里面</span><br>        <span class="hljs-keyword">for</span>(Object activty:choose)&#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> activty.getClass().getName();<br>            <span class="hljs-keyword">if</span>(!name.equals(MainActivity.class.getName())&amp;&amp;<br>                    !name.equals(ShareActivity.class.getName())&amp;&amp;<br>                        !name.equals(FeedbackActivity.class.getName())<br>                )&#123;<br>                list.add(activty);<br>            &#125;<br>        &#125;<br>        <span class="hljs-comment">//判断list数量是否大于1</span><br>        <span class="hljs-keyword">if</span> (list.size() &gt;= <span class="hljs-number">1</span>) &#123;<br>            <span class="hljs-type">ListItemBean</span> <span class="hljs-variable">item</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ListItemBean</span>(<br>                    <span class="hljs-string">&quot;检测到APK存在沙箱内部&quot;</span>,<br>                    ListItemBean.RiskLeave.Deadly);<br>            <span class="hljs-keyword">for</span> (Object obj : list) &#123;<br>                item.putData(obj.getClass().getName());<br>            &#125;<br>            <span class="hljs-keyword">return</span> item;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>检测Google&amp;lineageos<br>因为在国内手机里基本Google和lineageos都是黑产的标配 ，大部分都是自己刷的ROM 。</p>
<p>这种手机理论上在国内 不应该出现，如果出现也会被打上标签，被认定为黑产 。可以直接Build.MODEL 获取厂商 。</p>
<p>另外这块还有一个细节点 ，就是lineageos一个特有文件&#x2F;system&#x2F;addon.d 。具体如下 。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">isLineageOs</span><span class="hljs-params">(ArrayList&lt;ListItemBean&gt; items)</span> &#123;<br>    <span class="hljs-comment">//lineage检测</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">display</span> <span class="hljs-operator">=</span> NativeEngine.getZhenxiInfoH(<span class="hljs-string">&quot;ro.build.display.id&quot;</span>);<br>    <span class="hljs-keyword">if</span> (display.toLowerCase(Locale.ROOT).contains(<span class="hljs-string">&quot;lineage&quot;</span>)) &#123;<br>        items.add(<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ListItemBean</span>(<span class="hljs-string">&quot;当前手机为Lineage系统&quot;</span>,<br>                        ListItemBean.RiskLeave.Warn,<br>                        <span class="hljs-string">&quot;可能存在自定义ROM,当前设备不可信！&quot;</span><br>                ));<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br>    <span class="hljs-comment">//lineage 特有文件</span><br>    <span class="hljs-type">File</span> <span class="hljs-variable">file</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">&quot;/system/addon.d&quot;</span>);<br>    <span class="hljs-keyword">if</span> (file.exists()) &#123;<br>        items.add(<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ListItemBean</span>(<span class="hljs-string">&quot;当前手机为Lineage系统&quot;</span>,<br>                        ListItemBean.RiskLeave.Warn,<br>                        <span class="hljs-string">&quot;可能存在自定义ROM,当前设备不可信！&quot;</span><br>                ));<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>当然这块有一个细节点：</p>
<p>直接获取 ro.build.display.id 可能会被Hook ，所以这块我的建议是直接去解析配置文件 。</p>
<p>核心解析（&#x2F;dev&#x2F;properties&#x2F;u:object_r: ）文件方法如下 ：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">    public PropArea(String area) throws IOException &#123;<br>        area = &quot;/dev/__properties__/u:object_r:&quot; + area + &quot;:s0&quot;;<br>        File file = new File(area);<br>        if (!file.isFile()) throw new FileNotFoundException(&quot;Not a file: &quot; + area);<br>        long size = file.length();<br>        if (size &lt;= 0 || size &gt;= 0x7fffffffL) throw new IllegalArgumentException(&quot;invalid file size &quot; + size);<br> <br>        try (FileChannel channel = new FileInputStream(area).getChannel()) &#123;<br>            data = channel.map(FileChannel.MapMode.READ_ONLY, 0, size).order(ByteOrder.nativeOrder());<br>        &#125;<br> <br>        byteUsed = data.getInt();<br>        data.getInt(); // serial<br>        int magic = data.getInt();<br>        if (magic != PROP_AREA_MAGIC) throw new IllegalArgumentException(&quot;Bad file magic: &quot; + magic);<br>        int version = data.getInt();<br>        if (version != PROP_AREA_VERSION) throw new IllegalArgumentException(&quot;Bad area versin: &quot; + version);<br>        data.position(data.position() + 28); // reserved<br>    &#125;<br> <br>public List&lt;String&gt; findPossibleValues(String name) &#123;<br>    List&lt;String&gt; values ;<br>    try &#123;<br>        //  atomic_uint_least32_t serial;<br>        //  union &#123;<br>        //    char value[PROP_VALUE_MAX];<br>        //    struct &#123;<br>        //      char error_message[kLongLegacyErrorBufferSize];<br>        //      uint32_t offset;<br>        //    &#125; long_property;<br>        //  &#125;;<br>        final int LONG_PROP_FLAG = 1 &lt;&lt; 16;<br>        final int PROP_VALUE_MAX = 92;<br>        final int VALUE_OFFSET = 4;<br>        final int NAME_OFFSET = VALUE_OFFSET + 92;<br>        values = new ArrayList&lt;&gt;(2);<br>        findFromBuffer(data.slice(), name.getBytes(StandardCharsets.UTF_8), (buffer, offset) -&gt; &#123;<br>            if (offset &lt; NAME_OFFSET) return;<br>            int base = offset - NAME_OFFSET;<br>            int serial = buffer.getInt(base);<br>            if ((serial &amp; LONG_PROP_FLAG) != 0) return; // Long properties are not supported<br>            values.add(toString(buffer, base + VALUE_OFFSET, PROP_VALUE_MAX));<br>        &#125;);<br>        CLog.i(&quot;Found &quot; + name + &quot;=&quot; + values);<br>        return values;<br>    &#125; catch (Throwable e) &#123;<br>        CLog.e(&quot;findPossibleValues get error &quot;+ name+&quot; &quot;+e);<br>        return null;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>检测IDA和反调试：<br>这块检测方法太多了，我知道的就不下于10种，比如核心A和B方法里面加个时间搓，如果A执行到B大于5秒就可以认为被调试 。</p>
<p>检测调试状态也是很不错的选择，不过这块可以利用ISO线程去检测调试状态，防止被ptrace</p>
<p>service list<br>也可以执行 “service list” 获取服务列表 ，判断是否包含frida关键字 。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> CheckServerRet <span class="hljs-title function_">checkServer</span><span class="hljs-params">(Context context, String[] fit)</span> &#123;<br>    <span class="hljs-type">CheckServerRet</span> <span class="hljs-variable">ret</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CheckServerRet</span>();<br>    ArrayList&lt;String&gt; list = ret.list;<br>    <span class="hljs-type">BufferedReader</span> <span class="hljs-variable">reader</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    Process process;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-comment">// 执行 service list 命令</span><br>        process = Runtime.getRuntime().exec(<span class="hljs-string">&quot;service list&quot;</span>);<br> <br>        <span class="hljs-comment">// 读取命令输出结果</span><br>        reader = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedReader</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InputStreamReader</span>(process.getInputStream()));<br>        String line;<br>        <span class="hljs-keyword">while</span> ((line = reader.readLine()) != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">if</span> (line.length() &gt; <span class="hljs-number">1</span>) &#123;<br>                <span class="hljs-keyword">for</span> (String fitItem : fit) &#123;<br>                    <span class="hljs-comment">//比较不区分大小写</span><br>                    <span class="hljs-keyword">if</span> (line.toLowerCase().contains(fitItem.toLowerCase())) &#123;<br>                        list.add(line);<br>                        <span class="hljs-comment">//CLog.e(&quot;checkServer find item is match &quot; + Arrays.toString(fit) + &quot; &quot; + line);</span><br>                        <span class="hljs-keyword">break</span>;<br>                    &#125; <span class="hljs-keyword">else</span> &#123;<br>                        <span class="hljs-comment">//走到这里说明能拿到。返回的不是空</span><br>                        ret.isSuccess = <span class="hljs-literal">true</span>;<br>                    &#125;<br>                &#125;<br>            &#125;<br>        &#125;<br> <br>        <span class="hljs-comment">// 关闭流</span><br>        reader.close();<br> <br>        <span class="hljs-comment">// 等待命令执行完毕</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">exitValue</span> <span class="hljs-operator">=</span> process.waitFor();<br>        CLog.e(<span class="hljs-string">&quot;checkServer ret mark &quot;</span> + Arrays.toString(fit) + <span class="hljs-string">&quot; &quot;</span> + ret);<br>        <span class="hljs-keyword">return</span> ret;<br>    &#125; <span class="hljs-keyword">catch</span> (IOException | InterruptedException e) &#123;<br>        e.printStackTrace();<br>        <span class="hljs-keyword">if</span> (reader != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                reader.close();<br>            &#125; <span class="hljs-keyword">catch</span> (IOException ignored) &#123;<br> <br>            &#125;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> ret;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>后语：<br>如果你使用了这个帖子里面的代码，请备注出处 。感谢理解 ！</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="http://example.com">听说你是小兔叽</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://example.com/2023/05/29/%E8%81%8A%E8%81%8A%E5%A4%A7%E5%8E%82%E8%AE%BE%E5%A4%87%E6%8C%87%E7%BA%B9%E5%85%B6%E4%BA%8CHunter%E7%8E%AF%E5%A2%83%E6%A3%80%E6%B5%8B%E6%80%9D%E8%B7%AF%E8%AF%A6%E8%A7%A3/">http://example.com/2023/05/29/%E8%81%8A%E8%81%8A%E5%A4%A7%E5%8E%82%E8%AE%BE%E5%A4%87%E6%8C%87%E7%BA%B9%E5%85%B6%E4%BA%8CHunter%E7%8E%AF%E5%A2%83%E6%A3%80%E6%B5%8B%E6%80%9D%E8%B7%AF%E8%AF%A6%E8%A7%A3/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://example.com" target="_blank">听说你是小兔叽的博客</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E8%BD%AC%E8%B4%B4/">转贴</a><a class="post-meta__tags" href="/tags/%E7%8E%AF%E5%A2%83%E6%A3%80%E6%B5%8B/">环境检测</a></div><div class="post_share"><div class="social-share" data-image="/linear-gradient(20deg,%20#0062be,%20#925696,%20#cc426e,%20#fb0347)" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="next-post pull-full"><a href="/2022/12/12/seccomp-bpf-ptrace%E5%AE%9E%E7%8E%B0%E4%BF%AE%E6%94%B9%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8%E7%9A%84demo/"><img class="next-cover" src="/linear-gradient(20deg,%20#0062be,%20#925696,%20#cc426e,%20#fb0347)" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info"></div></div></a></div></nav><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="gitalk-container"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/favicon.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">听说你是小兔叽</div><div class="author-info__description">V+ RWY20161213</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">14</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">22</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xiaotujinbnb"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">听说你是小兔叽嘛的个人博客 大佬勿喷哇</div></div><div class="sticky_layout"><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2023/05/29/%E8%81%8A%E8%81%8A%E5%A4%A7%E5%8E%82%E8%AE%BE%E5%A4%87%E6%8C%87%E7%BA%B9%E5%85%B6%E4%BA%8CHunter%E7%8E%AF%E5%A2%83%E6%A3%80%E6%B5%8B%E6%80%9D%E8%B7%AF%E8%AF%A6%E8%A7%A3/" title="聊聊大厂设备指纹其二Hunter环境检测思路详解!"><img src="/linear-gradient(20deg,%20#0062be,%20#925696,%20#cc426e,%20#fb0347)" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="聊聊大厂设备指纹其二Hunter环境检测思路详解!"/></a><div class="content"><a class="title" href="/2023/05/29/%E8%81%8A%E8%81%8A%E5%A4%A7%E5%8E%82%E8%AE%BE%E5%A4%87%E6%8C%87%E7%BA%B9%E5%85%B6%E4%BA%8CHunter%E7%8E%AF%E5%A2%83%E6%A3%80%E6%B5%8B%E6%80%9D%E8%B7%AF%E8%AF%A6%E8%A7%A3/" title="聊聊大厂设备指纹其二Hunter环境检测思路详解!">聊聊大厂设备指纹其二Hunter环境检测思路详解!</a><time datetime="2023-05-29T03:57:45.000Z" title="发表于 2023-05-29 11:57:45">2023-05-29</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/12/12/seccomp-bpf-ptrace%E5%AE%9E%E7%8E%B0%E4%BF%AE%E6%94%B9%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8%E7%9A%84demo/" title="无题"><img src="/linear-gradient(20deg,%20#0062be,%20#925696,%20#cc426e,%20#fb0347)" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="无题"/></a><div class="content"><a class="title" href="/2022/12/12/seccomp-bpf-ptrace%E5%AE%9E%E7%8E%B0%E4%BF%AE%E6%94%B9%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8%E7%9A%84demo/" title="无题">无题</a><time datetime="2022-12-12T10:06:01.176Z" title="发表于 2022-12-12 18:06:01">2022-12-12</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/12/06/seccomp-bpf/" title="seccomp-bpf"><img src="/img/5518.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="seccomp-bpf"/></a><div class="content"><a class="title" href="/2022/12/06/seccomp-bpf/" title="seccomp-bpf">seccomp-bpf</a><time datetime="2022-12-06T07:37:53.000Z" title="发表于 2022-12-06 15:37:53">2022-12-06</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/12/05/OPENAI/" title="OPENAI"><img src="/img/5522.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="OPENAI"/></a><div class="content"><a class="title" href="/2022/12/05/OPENAI/" title="OPENAI">OPENAI</a><time datetime="2022-12-04T17:03:51.000Z" title="发表于 2022-12-05 01:03:51">2022-12-05</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/11/29/frida%E5%B8%B8%E7%94%A8%E4%BB%A3%E7%A0%81/" title="frida常用代码"><img src="/img/5521.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="frida常用代码"/></a><div class="content"><a class="title" href="/2022/11/29/frida%E5%B8%B8%E7%94%A8%E4%BB%A3%E7%A0%81/" title="frida常用代码">frida常用代码</a><time datetime="2022-11-29T08:04:21.000Z" title="发表于 2022-11-29 16:04:21">2022-11-29</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2023 By 听说你是小兔叽</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>function addGitalkSource () {
  const ele = document.createElement('link')
  ele.rel = 'stylesheet'
  ele.href= 'https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css'
  document.getElementsByTagName('head')[0].appendChild(ele)
}

function loadGitalk () {
  function initGitalk () {
    var gitalk = new Gitalk(Object.assign({
      clientID: '1b2ada67a8742b0079ce',
      clientSecret: '376bf937f2dacbc08bc3ccfdf2f80cd6b3246980',
      repo: 'xiaotujinbnb.github.io',
      owner: 'xiaotujinbnb',
      admin: ['xiaotujinbnb'],
      id: '6e71c2f284c9d117ace81e369b02fddb',
      updateCountCallback: commentCount
    },null))

    gitalk.render('gitalk-container')
  }

  if (typeof Gitalk === 'function') initGitalk()
  else {
    addGitalkSource()
    getScript('https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.js').then(initGitalk)
  }
}

function commentCount(n){
  let isCommentCount = document.querySelector('#post-meta .gitalk-comment-count')
  if (isCommentCount) {
    isCommentCount.innerHTML= n
  }
}

if ('Gitalk' === 'Gitalk' || !false) {
  if (false) btf.loadComment(document.getElementById('gitalk-container'), loadGitalk)
  else loadGitalk()
} else {
  function loadOtherComment () {
    loadGitalk()
  }
}</script></div><canvas class="fireworks" mobile="false"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/fireworks.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = true;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>